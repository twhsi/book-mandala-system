<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>曼陀羅專案管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --bg-color: #f8fafc;
            --danger-color: #dc2626;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            min-height: 100vh;
        }
        
        .sidebar {
            width: 180px;
            min-width: 180px;
            transition: margin-left 0.3s ease;
        }
        
        .sidebar.collapsed {
            margin-left: -180px;
        }
        
        .main-content {
            transition: margin-left 0.3s ease;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        .mandala-grid {
            display: grid;
            grid-template-columns: repeat(3, 150px);
            grid-template-rows: repeat(3, 110px);
            gap: 2px;
            background-color: #cbd5e1;
            padding: 2px;
            border-radius: 8px;
            margin: 0 auto;
        }
        
        .mandala-cell {
            background: white;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .mandala-cell:hover {
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        }
        
        .mandala-cell.center {
            background: #1e40af;
            color: white;
        }
        
        .mandala-cell.center .cell-label {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .cell-label {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .cell-content {
            width: 100%;
            height: calc(100% - 8px);
            margin-top: 24px;
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            color: inherit;
        }
        
        .cell-content::placeholder {
            color: #94a3b8;
            font-size: 14px;
        }
        
        .project-item {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .project-item:hover {
            background-color: #e2e8f0;
        }
        
        .project-item.active {
            background-color: #dbeafe;
            border-left-color: var(--primary-color);
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .status-synced { background: #10b981; }
        .status-syncing { background: #f59e0b; animation: pulse 2s infinite; }
        .status-error { background: #ef4444; }
        .status-offline { background: #6b7280; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                background: white;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                z-index: 100;
            }
            
            .mandala-grid {
                grid-template-columns: repeat(3, 120px);
                grid-template-rows: repeat(3, 90px);
            }
        }
    </style>
</head>
<body>
    <!-- 工具列 -->
    <header class="bg-white border-b border-gray-200 h-10 flex items-center px-4 sticky top-0 z-50">
        <button id="toggleSidebar" class="btn btn-secondary text-sm mr-4">
            <i class="fas fa-bars"></i>
        </button>
        
        <input type="text" id="projectTitle" placeholder="專案標題" 
               class="flex-1 px-3 py-1 border border-gray-300 rounded mr-4 text-sm">
        
        <div class="flex gap-2">
            <button id="saveBtn" class="btn btn-primary text-sm">
                <i class="fas fa-save"></i> 儲存
            </button>
            <button id="loadBtn" class="btn btn-secondary text-sm">
                <i class="fas fa-undo"></i> 回覆
            </button>
            <button id="exportBtn" class="btn btn-secondary text-sm">
                <i class="fas fa-download"></i> 匯出
            </button>
            <button id="importBtn" class="btn btn-secondary text-sm">
                <i class="fas fa-upload"></i> 匯入
            </button>
            <button id="githubBtn" class="btn btn-secondary text-sm">
                <i class="fab fa-github"></i> 雲端
            </button>
        </div>
        
        <input type="file" id="importFile" accept=".opml,.xml" style="display: none">
    </header>

    <div class="flex h-screen pt-10">
        <!-- 左側專案選單 -->
        <div id="sidebar" class="sidebar bg-white border-r border-gray-200 overflow-y-auto">
            <div class="p-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-800">專案管理</h2>
                    <span id="syncStatus" class="status-indicator status-offline"></span>
                </div>
                
                <button id="newProjectBtn" class="btn btn-primary w-full mb-4 text-sm">
                    <i class="fas fa-plus"></i> 新建專案
                </button>
                
                <div id="projectList" class="space-y-1">
                    <!-- 專案列表將動態生成 -->
                </div>
            </div>
        </div>

        <!-- 主編輯區域 -->
        <div id="mainContent" class="main-content flex-1 flex flex-col">
            <div id="welcomeScreen" class="flex-1 flex items-center justify-center">
                <div class="text-center text-gray-500">
                    <i class="fas fa-th-large text-6xl mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">歡迎使用曼陀羅專案管理系統</h3>
                    <p>選擇左側專案或建立新專案開始編輯</p>
                </div>
            </div>
            
            <div id="editArea" class="flex-1 p-6" style="display: none;">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 id="currentTitle" class="text-xl font-bold text-gray-800"></h1>
                            <p id="currentSubtitle" class="text-sm text-gray-600"></p>
                        </div>
                        
                        <div class="flex gap-2">
                            <button id="backBtn" class="btn btn-secondary text-sm" style="display: none;">
                                <i class="fas fa-arrow-left"></i> 返回第一層
                            </button>
                            <button id="clearCurrentBtn" class="btn btn-danger text-sm">
                                <i class="fas fa-eraser"></i> 清除當前層
                            </button>
                            <button id="clearAllBtn" class="btn btn-danger text-sm">
                                <i class="fas fa-trash"></i> 清除整個曼陀羅
                            </button>
                        </div>
                    </div>
                    
                    <div class="mandala-grid" id="mandalaGrid">
                        <!-- 九宮格將動態生成 -->
                    </div>
                    
                    <div class="mt-6 text-center text-sm text-gray-500" id="navInfo">
                        點擊 A、B、C、D、E、F、G、H 進入第二層九宮格編輯
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GitHub 設定模態框 -->
    <div id="githubModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">GitHub 雲端同步設定</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">GitHub Token</label>
                    <input type="password" id="githubToken" 
                           class="w-full px-3 py-2 border border-gray-300 rounded" 
                           placeholder="輸入您的 GitHub Personal Access Token">
                </div>
                <div class="flex gap-2">
                    <button id="saveGithubBtn" class="btn btn-primary">儲存設定</button>
                    <button id="cancelGithubBtn" class="btn btn-secondary">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let currentProject = null;
        let currentLevel = 1; // 1=第一層, 2=第二層
        let currentSection = null; // A..H
        let projects = {};
        let githubToken = localStorage.getItem('githubToken') || '';
        let sidebarCollapsed = false;

        // 專案結構模板
        const projectTemplate = {
            title: '',
            level1: {
                center: { label: '中心', content: '' },
                sections: {
                    F: { label: 'F', content: '' },
                    C: { label: 'C', content: '' },
                    G: { label: 'G', content: '' },
                    B: { label: 'B', content: '' },
                    D: { label: 'D', content: '' },
                    E: { label: 'E', content: '' },
                    A: { label: 'A', content: '' },
                    H: { label: 'H', content: '' }
                }
            },
            level2: {}
        };

        // 初始化level2結構
        ['A','B','C','D','E','F','G','H'].forEach(letter => {
            projectTemplate.level2[letter] = {
                center: { label: letter, content: '' },
                sections: {
                    '6': { label: '6', content: '' },
                    '3': { label: '3', content: '' },
                    '7': { label: '7', content: '' },
                    '2': { label: '2', content: '' },
                    '4': { label: '4', content: '' },
                    '5': { label: '5', content: '' },
                    '1': { label: '1', content: '' },
                    '8': { label: '8', content: '' }
                }
            };
        });

        // 默認專案列表
        const defaultProjects = [
            { id: '2.6.1', name: '2.6.1 目標', series: '2.6' },
            { id: '2.6.2', name: '2.6.2 阻礙', series: '2.6' },
            { id: '2.6.3', name: '2.6.3 努力', series: '2.6' },
            { id: '2.6.4', name: '2.6.4 結果', series: '2.6' },
            { id: '2.6.5', name: '2.6.5 意外', series: '2.6' },
            { id: '2.6.6', name: '2.6.6 轉彎', series: '2.6' },
            { id: '2.6.7', name: '2.6.7 結局', series: '2.6' },
            { id: '2.7.1', name: '2.7.1 目標', series: '2.7' },
            { id: '2.7.2', name: '2.7.2 阻礙', series: '2.7' },
            { id: '2.7.3', name: '2.7.3 努力', series: '2.7' },
            { id: '2.7.4', name: '2.7.4 結果', series: '2.7' },
            { id: '2.7.5', name: '2.7.5 意外', series: '2.7' },
            { id: '2.7.6', name: '2.7.6 轉彎', series: '2.7' },
            { id: '2.7.7', name: '2.7.7 結局', series: '2.7' },
            { id: '2.8.1', name: '2.8.1 目標', series: '2.8' },
            { id: '2.8.2', name: '2.8.2 阻礙', series: '2.8' },
            { id: '2.8.3', name: '2.8.3 努力', series: '2.8' },
            { id: '2.8.4', name: '2.8.4 結果', series: '2.8' },
            { id: '2.8.5', name: '2.8.5 意外', series: '2.8' },
            { id: '2.8.6', name: '2.8.6 轉彎', series: '2.8' },
            { id: '2.8.7', name: '2.8.7 結局', series: '2.8' },
            { id: '2.9.1', name: '2.9.1 目標', series: '2.9' },
            { id: '2.9.2', name: '2.9.2 阻礙', series: '2.9' },
            { id: '2.9.3', name: '2.9.3 努力', series: '2.9' },
            { id: '2.9.4', name: '2.9.4 結果', series: '2.9' },
            { id: '2.9.5', name: '2.9.5 意外', series: '2.9' },
            { id: '2.9.6', name: '2.9.6 轉彎', series: '2.9' },
            { id: '2.9.7', name: '2.9.7 結局', series: '2.9' }
        ];

        // 九宮格排列順序
        const level1Order = ['F', 'C', 'G', 'B', 'CENTER', 'D', 'E', 'A', 'H'];
        const level2Order = ['6', '3', '7', '2', 'CENTER', '4', '5', '1', '8'];

        // 初始化
        function init() {
            loadProjects();
            renderProjectList();
            bindEvents();
            checkUrlHash();
            
            // 自動選擇第一個專案
            if (Object.keys(projects).length > 0 && !currentProject) {
                const firstProject = Object.keys(projects)[0];
                selectProject(firstProject);
            }
        }

        // 載入專案資料
        function loadProjects() {
            const saved = localStorage.getItem('mandalaProjects');
            if (saved) {
                projects = JSON.parse(saved);
            } else {
                // 初始化默認專案
                defaultProjects.forEach(proj => {
                    projects[proj.id] = {
                        ...JSON.parse(JSON.stringify(projectTemplate)),
                        title: proj.name
                    };
                });
                saveProjects();
            }
        }

        // 儲存專案資料
        function saveProjects() {
            localStorage.setItem('mandalaProjects', JSON.stringify(projects));
            updateSyncStatus('synced');
        }

        // 渲染專案列表
        function renderProjectList() {
            const container = document.getElementById('projectList');
            const seriesGroups = {};
            
            // 按系列分組
            Object.keys(projects).forEach(id => {
                const series = id.substring(0, 3); // 2.6, 2.7, etc.
                if (!seriesGroups[series]) {
                    seriesGroups[series] = [];
                }
                seriesGroups[series].push({ id, ...projects[id] });
            });
            
            let html = '';
            Object.keys(seriesGroups).sort().forEach(series => {
                html += `<div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">${series} 系列</h4>`;
                
                seriesGroups[series].forEach(project => {
                    const isActive = currentProject === project.id ? 'active' : '';
                    html += `<div class="project-item ${isActive}" data-id="${project.id}">
                        <div class="text-sm font-medium">${project.title}</div>
                    </div>`;
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // 選擇專案
        function selectProject(projectId) {
            currentProject = projectId;
            currentLevel = 1;
            currentSection = null;
            
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('editArea').style.display = 'block';
            
            updateTitle();
            renderMandala();
            renderProjectList();
            updateUrl();
        }

        // 更新標題
        function updateTitle() {
            if (!currentProject) return;
            
            const project = projects[currentProject];
            document.getElementById('projectTitle').value = project.title;
            document.getElementById('currentTitle').textContent = project.title;
            
            let subtitle = '';
            if (currentLevel === 1) {
                subtitle = '第一層：主要架構';
            } else {
                subtitle = `第二層：${currentSection} 區域詳細內容`;
            }
            document.getElementById('currentSubtitle').textContent = subtitle;
        }

        // 渲染曼陀羅九宮格
        function renderMandala() {
            if (!currentProject) return;
            
            const container = document.getElementById('mandalaGrid');
            const project = projects[currentProject];
            const order = currentLevel === 1 ? level1Order : level2Order;
            
            container.innerHTML = '';
            
            order.forEach(pos => {
                const cell = document.createElement('div');
                cell.className = 'mandala-cell';
                
                if (pos === 'CENTER') {
                    cell.classList.add('center');
                    const centerData = currentLevel === 1 
                        ? project.level1.center 
                        : project.level2[currentSection].center;
                    
                    cell.innerHTML = `
                        <div class="cell-label center-label">${centerData.label}</div>
                        <textarea class="cell-content" placeholder="中心主題..."
                                  onchange="updateContent('center', '${pos}', this.value)">${centerData.content}</textarea>
                    `;
                } else {
                    const sectionData = currentLevel === 1 
                        ? project.level1.sections[pos]
                        : project.level2[currentSection].sections[pos];
                    
                    const onClick = currentLevel === 1 && pos !== 'CENTER' 
                        ? `onclick="enterLevel2('${pos}')"` 
                        : '';
                    
                    cell.innerHTML = `
                        <div class="cell-label" ${onClick}>${sectionData.label}</div>
                        <textarea class="cell-content" placeholder="輸入內容..."
                                  onchange="updateContent('section', '${pos}', this.value)">${sectionData.content}</textarea>
                    `;
                }
                
                container.appendChild(cell);
            });
            
            // 更新導航資訊
            const navInfo = document.getElementById('navInfo');
            const backBtn = document.getElementById('backBtn');
            
            if (currentLevel === 1) {
                navInfo.textContent = '點擊 A、B、C、D、E、F、G、H 進入第二層九宮格編輯';
                backBtn.style.display = 'none';
            } else {
                navInfo.textContent = `正在編輯 ${currentSection} 區域的詳細內容`;
                backBtn.style.display = 'inline-flex';
            }
        }

        // 進入第二層
        function enterLevel2(section) {
            currentLevel = 2;
            currentSection = section;
            updateTitle();
            renderMandala();
            updateUrl();
        }

        // 返回第一層
        function goBack() {
            currentLevel = 1;
            currentSection = null;
            updateTitle();
            renderMandala();
            updateUrl();
        }

        // 更新內容
        function updateContent(type, position, value) {
            if (!currentProject) return;
            
            const project = projects[currentProject];
            
            if (type === 'center') {
                if (currentLevel === 1) {
                    project.level1.center.content = value;
                } else {
                    project.level2[currentSection].center.content = value;
                }
            } else {
                if (currentLevel === 1) {
                    project.level1.sections[position].content = value;
                    // 同步到level2的center
                    if (project.level2[position]) {
                        project.level2[position].center.content = value;
                    }
                } else {
                    project.level2[currentSection].sections[position].content = value;
                }
            }
            
            saveProjects();
        }

        // 更新同步狀態
        function updateSyncStatus(status) {
            const indicator = document.getElementById('syncStatus');
            indicator.className = `status-indicator status-${status}`;
        }

        // 更新URL
        function updateUrl() {
            let hash = '';
            if (currentProject) {
                hash = `#/mandala/${currentProject}`;
                if (currentLevel === 2 && currentSection) {
                    hash += `/${currentSection}`;
                }
            }
            window.location.hash = hash;
        }

        // 檢查URL Hash
        function checkUrlHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#/mandala/')) {
                const parts = hash.split('/');
                const projectId = parts[2];
                if (projects[projectId]) {
                    selectProject(projectId);
                    if (parts[3] && ['A','B','C','D','E','F','G','H'].includes(parts[3])) {
                        enterLevel2(parts[3]);
                    }
                }
            }
        }

        // 切換側邊欄
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebarCollapsed = !sidebarCollapsed;
            
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
            } else {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
            }
        }

        // 匯出OPML
        function exportOPML() {
            if (!currentProject) {
                alert('請先選擇一個專案');
                return;
            }
            
            const project = projects[currentProject];
            const timestamp = new Date().toISOString().slice(0, 16).replace(/[-:]/g, '').replace('T', '_');
            const filename = `mandala_${currentProject}_${timestamp}.opml`;
            
            const opml = generateOPML(project);
            downloadFile(opml, filename, 'text/xml');
        }

        // 生成OPML
        function generateOPML(project) {
            let opml = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
    <head><title>${escapeXml(project.title)}</title></head>
    <body>
        <outline text="中心: ${escapeXml(project.level1.center.content)}">`;
            
            ['A','B','C','D','E','F','G','H'].forEach(letter => {
                const section = project.level1.sections[letter];
                const level2 = project.level2[letter];
                
                opml += `
            <outline text="${letter}: ${escapeXml(section.content)}">`;
                
                ['1','2','3','4','5','6','7','8'].forEach(num => {
                    const cell = level2.sections[num];
                    opml += `
                <outline text="${num}: ${escapeXml(cell.content)}"/>`;
                });
                
                opml += `
            </outline>`;
            });
            
            opml += `
        </outline>
    </body>
</opml>`;
            
            return opml;
        }

        // 下載檔案
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // XML轉義
        function escapeXml(str) {
            return (str || '').replace(/[&<>"']/g, s => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                "\"": "&quot;",
                "'": "&apos;"
            }[s]));
        }

        // 匯入OPML
        function importOPML(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const xml = e.target.result;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xml, 'text/xml');
                    
                    // 解析OPML並更新當前專案
                    parseOPML(doc);
                    renderMandala();
                    alert('匯入成功！');
                } catch (error) {
                    alert('匯入失敗：檔案格式錯誤');
                }
            };
            reader.readAsText(file);
        }

        // 解析OPML
        function parseOPML(doc) {
            if (!currentProject) return;
            
            const project = projects[currentProject];
            const rootOutline = doc.querySelector('body > outline');
            
            if (rootOutline) {
                const rootText = rootOutline.getAttribute('text') || '';
                const centerMatch = rootText.match(/^中心:\s*(.*)/) || rootText.match(/^(.*)$/);
                project.level1.center.content = centerMatch ? centerMatch[1] : '';
                
                const sectionOutlines = rootOutline.querySelectorAll(':scope > outline');
                sectionOutlines.forEach(outline => {
                    const text = outline.getAttribute('text') || '';
                    const match = text.match(/^([A-H]):\s*(.*)$/);
                    
                    if (match) {
                        const letter = match[1];
                        const content = match[2];
                        
                        project.level1.sections[letter].content = content;
                        project.level2[letter].center.content = content;
                        
                        const cellOutlines = outline.querySelectorAll(':scope > outline');
                        cellOutlines.forEach(cellOutline => {
                            const cellText = cellOutline.getAttribute('text') || '';
                            const cellMatch = cellText.match(/^([1-8]):\s*(.*)$/);
                            
                            if (cellMatch) {
                                const num = cellMatch[1];
                                const cellContent = cellMatch[2];
                                project.level2[letter].sections[num].content = cellContent;
                            }
                        });
                    }
                });
            }
            
            saveProjects();
        }

        // 清除功能
        function clearCurrent() {
            if (!currentProject) return;
            
            const confirmMsg = currentLevel === 1 
                ? '確定要清除第一層的 A-H 區域內容嗎？'
                : `確定要清除 ${currentSection} 區域的 1-8 細節內容嗎？`;
            
            if (!confirm(confirmMsg)) return;
            
            const project = projects[currentProject];
            
            if (currentLevel === 1) {
                ['A','B','C','D','E','F','G','H'].forEach(letter => {
                    project.level1.sections[letter].content = '';
                    project.level2[letter].center.content = '';
                });
            } else {
                ['1','2','3','4','5','6','7','8'].forEach(num => {
                    project.level2[currentSection].sections[num].content = '';
                });
            }
            
            saveProjects();
            renderMandala();
        }

        function clearAll() {
            if (!currentProject) return;
            
            if (!confirm('確定要清除整個曼陀羅的所有內容嗎？此操作無法復原！')) return;
            
            const project = projects[currentProject];
            const newProject = JSON.parse(JSON.stringify(projectTemplate));
            newProject.title = project.title;
            
            projects[currentProject] = newProject;
            saveProjects();
            renderMandala();
        }

        // 綁定事件
        function bindEvents() {
            // 工具列按鈕
            document.getElementById('toggleSidebar').onclick = toggleSidebar;
            document.getElementById('saveBtn').onclick = saveProjects;
            document.getElementById('loadBtn').onclick = () => location.reload();
            document.getElementById('exportBtn').onclick = exportOPML;
            document.getElementById('importBtn').onclick = () => document.getElementById('importFile').click();
            document.getElementById('githubBtn').onclick = () => document.getElementById('githubModal').classList.add('show');
            
            // 專案標題更新
            document.getElementById('projectTitle').onchange = function() {
                if (currentProject) {
                    projects[currentProject].title = this.value;
                    saveProjects();
                    renderProjectList();
                    updateTitle();
                }
            };
            
            // 檔案匯入
            document.getElementById('importFile').onchange = function() {
                if (this.files[0]) {
                    importOPML(this.files[0]);
                }
            };
            
            // 編輯區按鈕
            document.getElementById('backBtn').onclick = goBack;
            document.getElementById('clearCurrentBtn').onclick = clearCurrent;
            document.getElementById('clearAllBtn').onclick = clearAll;
            
            // 專案列表點擊
            document.getElementById('projectList').onclick = function(e) {
                const item = e.target.closest('.project-item');
                if (item) {
                    selectProject(item.dataset.id);
                }
            };
            
            // GitHub 模態框
            document.getElementById('saveGithubBtn').onclick = function() {
                githubToken = document.getElementById('githubToken').value;
                localStorage.setItem('githubToken', githubToken);
                document.getElementById('githubModal').classList.remove('show');
                alert('GitHub 設定已儲存');
            };
            
            document.getElementById('cancelGithubBtn').onclick = function() {
                document.getElementById('githubModal').classList.remove('show');
            };
            
            // 新建專案
            document.getElementById('newProjectBtn').onclick = function() {
                const name = prompt('請輸入專案名稱：');
                if (name) {
                    const id = 'custom_' + Date.now();
                    projects[id] = {
                        ...JSON.parse(JSON.stringify(projectTemplate)),
                        title: name
                    };
                    saveProjects();
                    renderProjectList();
                    selectProject(id);
                }
            };
            
            // URL變化監聽
            window.onhashchange = checkUrlHash;
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"978a36df9cf78f1f","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.8.0","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDsZnTL85%2BaHbtcL5c%2FWy%2BQ4kl8C63J8O8ASnq27YxBkI7DqtL4%2FdI5xdzMfWAwfvPIXGV%2F3c7sz3Oh1%2BDkp0D17abWgShx5l9aDyZKj0t9Ym3LtY4o%2Byz3On2CrWijo0O%2BK1vh5mFTN8%2F5AQvE6m5vPy1OTwrF%2BpFiZjY9%2BexxYW5jXzHqPzhF7mZyjw7kQx0FLIUnCkbRR1%2FyvMCm0LSJXX%2B2%2BQ8F7B0GxKmRkY0SipX1peRjN88XL6Edw6fdmHyQ2y2NAHSnNnC2aHEmQz9kY0s9vhR1h8npEtnyMfK1%2BwjpZUmmAmrpUF5MWHr1vXWMS71l%2FUpmmfXE6PKyYMrtMms%2FK57yZ86ntZoqqHKH1K54ngREhfz4KDBoPRKf1PDxHjew3ULOklgz68pZJXC%2FUZ5y0glL9ym%2F2MTVjdVVTFU3GKEFOqIG7qmlktQYBDekeKlfAQ5tZTKE0Zhgb1Hw7AwtSqu%2B7EQdsQOfREf8c%2BwBoKmjAEQkp54AJALMfJ1rP1Uu1YF%2FpSw6YcV9NCVUc%3D";
        window.__genspark_locale = "zh-TW";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDsZnTL85+aHbtcL5c/Wy+Q4kl8C63J8O8ASnq27YxBkI7DqtL4/dI5xdzMfWAwfvPIXGV/3c7sz3Oh1+Dkp0D17abWgShx5l9aDyZKj0t9Ym3LtY4o+yz3On2CrWijo0O+K1vh5mFTN8/5AQvE6m5vPy1OTwrF+pFiZjY9+exxYW5jXzHqPzhF7mZyjw7kQx0FLIUnCkbRR1/yvMCm0LSJXX+2+Q8F7B0GxKmRkY0SipX1peRjN88XL6Edw6fdmHyQ2y2NAHSnNnC2aHEmQz9kY0s9vhR1h8npEtnyMfK1+wjpZUmmAmrpUF5MWHr1vXWMS71l/UpmmfXE6PKyYMrtMms/K57yZ86ntZoqqHKH1K54ngREhfz4KDBoPRKf1PDxHjew3ULOklgz68pZJXC/UZ5y0glL9ym/2MTVjdVVTFU3GKEFOqIG7qmlktQYBDekeKlfAQ5tZTKE0Zhgb1Hw7AwtSqu+7EQdsQOfREf8c+wBoKmjAEQkp54AJALMfJ1rP1Uu1YF/pSw6YcV9NCVUc=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    