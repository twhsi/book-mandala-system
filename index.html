<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›¼é™€ç¾…å°ˆæ¡ˆç®¡ç†ç³»çµ± v3.6 - çµ‚æ¥µå®Œæ•´ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        :root {
            --cell-font-size: 16px; /* é è¨­æ”¾å¤§å­—é«”ï¼Œç´„å¯å®¹ç´10å€‹å­— */
            --cell-line-height: 1.3;
        }
        
        .font-size-small {
            --cell-font-size: 12px;
            --cell-line-height: 1.2;
        }
        
        .font-size-medium {
            --cell-font-size: 16px;
            --cell-line-height: 1.3;
        }
        
        .font-size-large {
            --cell-font-size: 20px;
            --cell-line-height: 1.4;
        }
        
        .font-size-xlarge {
            --cell-font-size: 24px;
            --cell-line-height: 1.5;
        }
        
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f8fafc;
            overflow: hidden;
            height: 100vh;
        }

        .main-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .sidebar {
            width: 140px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            transition: width 0.3s ease;
            flex-shrink: 0;
        }

        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            height: 100vh;
        }

        .toolbar {
            height: 32px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            padding: 0 6px;
            gap: 3px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .toolbar button {
            height: 22px;
            padding: 0 6px;
            font-size: 10px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 3px;
            white-space: nowrap;
        }

        .toolbar button:hover {
            background: #e5e7eb;
        }

        .toolbar button.primary {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .toolbar button.danger {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .toolbar button.font-active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .font-size-controls {
            display: flex;
            gap: 2px;
            margin-left: 6px;
            padding-left: 6px;
            border-left: 1px solid #d1d5db;
        }

        .main-content {
            flex: 1;
            padding: 6px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .project-header {
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 20px;
            flex-shrink: 0;
        }

        .project-title {
            font-size: 14px;
            font-weight: bold;
            color: #1f2937;
        }

        .breadcrumb {
            font-size: 12px;
            color: #6b7280;
        }

        .mandala-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0;
            padding: 4px;
        }

        .mandala-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            aspect-ratio: 1;
            width: 100%;
            height: 100%;
            max-width: min(calc(100vh - 80px), calc(100vw - 160px));
            max-height: calc(100vh - 80px);
            background: #d1d5db;
            border-radius: 6px;
            padding: 2px;
        }

        .grid-cell {
            background: #f3f4f6;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            padding: 4px;
            min-height: 0;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .grid-cell:hover:not(.center) {
            background: #e5e7eb;
        }

        .grid-cell.center {
            background: #dbeafe;
            cursor: default;
        }

        .grid-cell.active-layer {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .cell-label {
            font-size: 9px;
            font-weight: bold;
            color: #374151;
            margin-bottom: 2px;
            text-align: center;
            flex-shrink: 0;
        }

        .cell-content {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: var(--cell-font-size);
            line-height: var(--cell-line-height);
            resize: none;
            width: 100%;
            min-height: 0;
            transition: font-size 0.2s ease;
        }

        .project-list {
            padding: 6px;
        }

        .project-group {
            margin-bottom: 8px;
        }

        .group-title {
            font-size: 11px;
            font-weight: bold;
            color: #374151;
            margin-bottom: 3px;
            padding: 3px 6px;
            background: #f3f4f6;
            border-radius: 3px;
        }

        .project-item {
            padding: 3px 6px;
            font-size: 10px;
            color: #6b7280;
            cursor: pointer;
            border-radius: 3px;
            margin-bottom: 1px;
            transition: background-color 0.2s;
            position: relative;
        }

        .project-item:hover {
            background: #f3f4f6;
        }

        .project-item.active {
            background: #dbeafe;
            color: #1d4ed8;
            font-weight: 600;
        }

        /* ç¢ºä¿é»æ“Šå€åŸŸè¦†è“‹æ•´å€‹é …ç›® */
        .project-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 9px;
            margin-left: auto;
        }

        .sync-status.syncing { color: #2563eb; }
        .sync-status.synced { color: #059669; }
        .sync-status.error { color: #dc2626; }
        .sync-status.offline { color: #6b7280; }
        .sync-status.auto-save { color: #f59e0b; }
        .sync-status.auto-upload { color: #8b5cf6; }

        .toggle-sidebar {
            position: absolute;
            top: 6px;
            left: 6px;
            z-index: 10;
            width: 18px;
            height: 18px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
        }

        .modal-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .modal-body {
            margin-bottom: 16px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
        }

        .form-checkbox {
            margin-right: 8px;
        }

        .form-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }

        /* å­å±¤æ ¼å­æ¨£å¼ */
        .grid-cell.sub-layer {
            background: #fef3c7;
        }

        .grid-cell.sub-center {
            background: #a7f3d0;
            cursor: pointer;
        }

        .grid-cell.sub-center:hover {
            background: #86efac;
        }

        /* TheBrain å„ªåŒ–æŒ‡ç¤ºå™¨ */
        .thebrain-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .thebrain-indicator.show {
            opacity: 1;
        }

        .thebrain-indicator.auto-upload {
            background: #8b5cf6;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 800px) {
            .sidebar {
                width: 120px;
            }
            .mandala-grid {
                max-width: calc(100vw - 140px);
            }
            .font-size-controls {
                display: none;
            }
        }

        @media (max-width: 600px) {
            .sidebar.collapsed {
                width: 0;
            }
            .mandala-grid {
                max-width: calc(100vw - 20px);
            }
            .toolbar {
                height: auto;
                min-height: 32px;
                padding: 3px;
            }
            .toolbar button {
                font-size: 9px;
                height: 20px;
                padding: 0 4px;
            }
        }

        /* ç¢ºä¿å®Œæ•´é¡¯ç¤º */
        @media (max-height: 600px) {
            .toolbar {
                height: 28px;
            }
            .toolbar button {
                height: 20px;
                font-size: 9px;
            }
            .project-header {
                height: 16px;
                margin-bottom: 2px;
            }
            .main-content {
                padding: 4px;
            }
        }
    </style>
</head>
<body>
    <!-- TheBrain å„ªåŒ–æŒ‡ç¤ºå™¨ -->
    <div class="thebrain-indicator" id="thebrainIndicator">
        <i class="fas fa-save"></i> è‡ªå‹•å„²å­˜ä¸­...
    </div>

    <div class="main-container font-size-medium" id="mainContainer">
        <div class="sidebar" id="sidebar">
            <div class="project-list" id="projectList">
                <button class="w-full mb-2 text-xs bg-blue-500 text-white p-1 rounded text-center" onclick="showGitHubModal()">
                    <i class="fas fa-cloud"></i> é›²ç«¯è¨­å®š
                </button>
                
                <div class="project-group">
                    <div class="group-title">2.6 ç³»åˆ—</div>
                    <div class="project-item" data-project="2.6.1">2.6.1 ç›®æ¨™</div>
                    <div class="project-item" data-project="2.6.2">2.6.2 é˜»ç¤™</div>
                    <div class="project-item" data-project="2.6.3">2.6.3 åŠªåŠ›</div>
                    <div class="project-item" data-project="2.6.4">2.6.4 çµæœ</div>
                    <div class="project-item" data-project="2.6.5">2.6.5 æ„å¤–</div>
                    <div class="project-item" data-project="2.6.6">2.6.6 è½‰å½</div>
                    <div class="project-item" data-project="2.6.7">2.6.7 çµå±€</div>
                </div>

                <div class="project-group">
                    <div class="group-title">2.7 ç³»åˆ—</div>
                    <div class="project-item" data-project="2.7.1">2.7.1 ç›®æ¨™</div>
                    <div class="project-item" data-project="2.7.2">2.7.2 é˜»ç¤™</div>
                    <div class="project-item" data-project="2.7.3">2.7.3 åŠªåŠ›</div>
                    <div class="project-item" data-project="2.7.4">2.7.4 çµæœ</div>
                    <div class="project-item" data-project="2.7.5">2.7.5 æ„å¤–</div>
                    <div class="project-item" data-project="2.7.6">2.7.6 è½‰å½</div>
                    <div class="project-item" data-project="2.7.7">2.7.7 çµå±€</div>
                </div>

                <div class="project-group">
                    <div class="group-title">2.8 ç³»åˆ—</div>
                    <div class="project-item" data-project="2.8.1">2.8.1 ç›®æ¨™</div>
                    <div class="project-item" data-project="2.8.2">2.8.2 é˜»ç¤™</div>
                    <div class="project-item" data-project="2.8.3">2.8.3 åŠªåŠ›</div>
                    <div class="project-item" data-project="2.8.4">2.8.4 çµæœ</div>
                    <div class="project-item" data-project="2.8.5">2.8.5 æ„å¤–</div>
                    <div class="project-item" data-project="2.8.6">2.8.6 è½‰å½</div>
                    <div class="project-item" data-project="2.8.7">2.8.7 çµå±€</div>
                </div>

                <div class="project-group">
                    <div class="group-title">2.9 ç³»åˆ—</div>
                    <div class="project-item" data-project="2.9.1">2.9.1 ç›®æ¨™</div>
                    <div class="project-item" data-project="2.9.2">2.9.2 é˜»ç¤™</div>
                    <div class="project-item" data-project="2.9.3">2.9.3 åŠªåŠ›</div>
                    <div class="project-item" data-project="2.9.4">2.9.4 çµæœ</div>
                    <div class="project-item" data-project="2.9.5">2.9.5 æ„å¤–</div>
                    <div class="project-item" data-project="2.9.6">2.9.6 è½‰å½</div>
                    <div class="project-item" data-project="2.9.7">2.9.7 çµå±€</div>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="toolbar">
                <button class="toggle-sidebar" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <button class="primary" onclick="saveLocal()">
                    <i class="fas fa-save"></i> å„²å­˜
                </button>
                
                <button onclick="loadLocal()">
                    <i class="fas fa-download"></i> è¼‰å…¥
                </button>
                
                <button onclick="importJSONFile()">
                    <i class="fas fa-file-import"></i> åŒ¯å…¥
                </button>
                
                <button onclick="exportJSON()">
                    <i class="fas fa-file-export"></i> åŒ¯å‡º
                </button>
                
                <button onclick="uploadGist()">
                    <i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³
                </button>
                
                <button onclick="downloadGist()">
                    <i class="fas fa-cloud-download-alt"></i> ä¸‹è¼‰
                </button>
                
                <button onclick="shareGist()">
                    <i class="fas fa-share"></i> åˆ†äº«
                </button>
                
                <button onclick="exportOPML()">
                    <i class="fas fa-file-code"></i> OPMLåŒ¯å‡º
                </button>
                
                <button onclick="importOPML()">
                    <i class="fas fa-file-upload"></i> OPMLåŒ¯å…¥
                </button>
                
                <button class="danger" onclick="clearAH()">
                    <i class="fas fa-eraser"></i> æ¸…é™¤A-H
                </button>
                
                <button class="danger" onclick="clearAll()">
                    <i class="fas fa-trash"></i> æ¸…é™¤å…¨éƒ¨
                </button>

                <!-- å­—é«”å¤§å°æ§åˆ¶ -->
                <div class="font-size-controls">
                    <button id="fontSmall" onclick="setFontSize('small')" title="å°å­—é«”">
                        <i class="fas fa-font"></i> å°
                    </button>
                    <button id="fontMedium" onclick="setFontSize('medium')" class="font-active" title="ä¸­å­—é«”">
                        <i class="fas fa-font"></i> ä¸­
                    </button>
                    <button id="fontLarge" onclick="setFontSize('large')" title="å¤§å­—é«”">
                        <i class="fas fa-font"></i> å¤§
                    </button>
                    <button id="fontXLarge" onclick="setFontSize('xlarge')" title="ç‰¹å¤§å­—é«”">
                        <i class="fas fa-font"></i> ç‰¹å¤§
                    </button>
                </div>

                <div class="sync-status offline" id="syncStatus">
                    <i class="fas fa-circle"></i>
                    <span>é›¢ç·š</span>
                </div>
            </div>

            <div class="main-content">
                <div class="project-header">
                    <div class="project-title" id="projectTitle">é¸æ“‡å°ˆæ¡ˆé–‹å§‹ç·¨è¼¯</div>
                    <div class="breadcrumb" id="breadcrumb">ä¸»å±¤</div>
                </div>

                <div class="mandala-container">
                    <div class="mandala-grid" id="mandalaGrid">
                        <!-- ä¸»å±¤ï¼šF-C-G / B-ä¸­å¿ƒ-D / E-A-H -->
                        <div class="grid-cell" data-position="F" onclick="enterLayer('F')">
                            <div class="cell-label">F</div>
                            <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="F"></textarea>
                        </div>
                        <div class="grid-cell" data-position="C" onclick="enterLayer('C')">
                            <div class="cell-label">C</div>
                            <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="C"></textarea>
                        </div>
                        <div class="grid-cell" data-position="G" onclick="enterLayer('G')">
                            <div class="cell-label">G</div>
                            <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="G"></textarea>
                        </div>
                        <div class="grid-cell" data-position="B" onclick="enterLayer('B')">
                            <div class="cell-label">B</div>
                            <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="B"></textarea>
                        </div>
                        <div class="grid-cell center" data-position="CENTER">
                            <div class="cell-label">ä¸­å¿ƒ</div>
                            <textarea class="cell-content" placeholder="å°ˆæ¡ˆæ ¸å¿ƒä¸»é¡Œ..." data-cell="CENTER"></textarea>
                        </div>
                        <div class="grid-cell" data-position="D" onclick="enterLayer('D')">
                            <div class="cell-label">D</div>
                            <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="D"></textarea>
                        </div>
                        <div class="grid-cell" data-position="E" onclick="enterLayer('E')">
                            <div class="cell-label">E</div>
                            <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="E"></textarea>
                        </div>
                        <div class="grid-cell" data-position="A" onclick="enterLayer('A')">
                            <div class="cell-label">A</div>
                            <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="A"></textarea>
                        </div>
                        <div class="grid-cell" data-position="H" onclick="enterLayer('H')">
                            <div class="cell-label">H</div>
                            <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="H"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GitHub è¨­å®š Modal -->
    <div class="modal" id="githubModal">
        <div class="modal-content">
            <div class="modal-header">GitHub é›²ç«¯è¨­å®š</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">GitHub Personal Access Token</label>
                    <input type="password" class="form-input" id="githubToken" placeholder="è¼¸å…¥æ‚¨çš„ GitHub Token">
                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                        éœ€è¦ gist æ¬Šé™ï¼Œç”¨æ–¼é›²ç«¯å„²å­˜åŒæ­¥
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Gist ID (å¯é¸)</label>
                    <input type="text" class="form-input" id="gistId" placeholder="ç•™ç©ºå°‡å»ºç«‹æ–°çš„ Gist">
                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                        ç”¨æ–¼è·¨ç€è¦½å™¨åŒæ­¥ï¼Œå¯æ‰‹å‹•è¼¸å…¥å·²å­˜åœ¨çš„ Gist ID
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" class="form-checkbox" id="noteModeToggle">
                        <span class="form-label" style="display: inline;">å•Ÿç”¨ç­†è¨˜æ¨¡å¼</span>
                    </label>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                        Enteréµè‡ªå‹•åŠ å‰ç¶´ï¼ŒShift+Enterç´”æ›è¡Œï¼ŒCtrl/Cmd+;æ’å…¥æ—¥æœŸ
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" class="form-checkbox" id="autoUploadToggle">
                        <span class="form-label" style="display: inline;">å•Ÿç”¨è‡ªå‹•ä¸Šå‚³</span>
                    </label>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                        å®šæ™‚è‡ªå‹•ä¸Šå‚³åˆ° GitHubï¼Œé¿å…æ‰‹å‹•æ“ä½œ
                    </div>
                </div>
                <div class="form-group" id="autoUploadIntervalGroup" style="display: none;">
                    <label class="form-label">è‡ªå‹•ä¸Šå‚³é–“éš”</label>
                    <select class="form-select" id="autoUploadInterval">
                        <option value="5">æ¯ 5 åˆ†é˜</option>
                        <option value="10" selected>æ¯ 10 åˆ†é˜</option>
                        <option value="30">æ¯ 30 åˆ†é˜</option>
                    </select>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                        åƒ…åœ¨æœ‰å…§å®¹è®Šæ›´æ™‚æ‰æœƒä¸Šå‚³
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeGitHubModal()">å–æ¶ˆ</button>
                <button class="primary" onclick="saveGitHubConfig()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- æª”æ¡ˆè¼¸å…¥ -->
    <input type="file" id="importJSONInput" accept=".json" style="display: none;" onchange="handleJSONImport(this)">
    <input type="file" id="importOPMLInput" accept=".opml,.xml" style="display: none;" onchange="handleOPMLImport(this)">

    <script>
        // ğŸ¯ çµ‚æ¥µç‰ˆæœ¬é‡é»ï¼šè‡ªå‹•å®šæ™‚ä¸Šå‚³ + å®Œå…¨ä¿®å¾©å·¦å´é¸å–®
        
        // å…¨åŸŸå„²å­˜ç®¡ç†å™¨
        const StorageManager = {
            // å¤šé‡å„²å­˜éµå€¼
            keys: {
                primary: 'mandala_data_v2',
                backup: 'mandala_backup_v2',
                session: 'mandala_session_v2'
            },
            
            // å„²å­˜é‡è©¦æ¬¡æ•¸
            maxRetries: 3,
            
            // å„²å­˜åˆ°å¤šå€‹ä½ç½®
            save: function(data, showIndicator = true) {
                const jsonData = JSON.stringify(data);
                let savedCount = 0;
                
                if (showIndicator) {
                    this.showSaveIndicator();
                }
                
                // ä¸»è¦å„²å­˜ (localStorage)
                try {
                    localStorage.setItem(this.keys.primary, jsonData);
                    savedCount++;
                } catch (e) {
                    console.warn('ä¸»è¦å„²å­˜å¤±æ•—:', e);
                }
                
                // å‚™ä»½å„²å­˜ (localStorage)
                try {
                    localStorage.setItem(this.keys.backup, jsonData);
                    savedCount++;
                } catch (e) {
                    console.warn('å‚™ä»½å„²å­˜å¤±æ•—:', e);
                }
                
                // æœƒè©±å„²å­˜ (sessionStorage)
                try {
                    sessionStorage.setItem(this.keys.session, jsonData);
                    savedCount++;
                } catch (e) {
                    console.warn('æœƒè©±å„²å­˜å¤±æ•—:', e);
                }
                
                console.log(`çµ‚æ¥µç‰ˆå„²å­˜: ${savedCount}/3 å„²å­˜ä½ç½®æˆåŠŸ`);
                return savedCount > 0;
            },
            
            // å¾å¤šå€‹ä½ç½®è¼‰å…¥
            load: function() {
                const sources = [
                    () => localStorage.getItem(this.keys.primary),
                    () => localStorage.getItem(this.keys.backup),
                    () => sessionStorage.getItem(this.keys.session)
                ];
                
                for (let i = 0; i < sources.length; i++) {
                    try {
                        const raw = sources[i]();
                        if (raw) {
                            const data = JSON.parse(raw);
                            console.log(`å¾ç¬¬ ${i + 1} å€‹ä½ç½®è¼‰å…¥è³‡æ–™æˆåŠŸ`);
                            return data;
                        }
                    } catch (e) {
                        console.warn(`ç¬¬ ${i + 1} å€‹ä½ç½®è¼‰å…¥å¤±æ•—:`, e);
                    }
                }
                
                console.log('æ‰€æœ‰å„²å­˜ä½ç½®éƒ½ç„¡æ³•è¼‰å…¥è³‡æ–™');
                return null;
            },
            
            // é¡¯ç¤ºå„²å­˜æŒ‡ç¤ºå™¨
            showSaveIndicator: function() {
                const indicator = document.getElementById('thebrainIndicator');
                indicator.classList.remove('auto-upload');
                indicator.innerHTML = '<i class="fas fa-save"></i> è‡ªå‹•å„²å­˜ä¸­...';
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            },

            // é¡¯ç¤ºä¸Šå‚³æŒ‡ç¤ºå™¨
            showUploadIndicator: function() {
                const indicator = document.getElementById('thebrainIndicator');
                indicator.classList.add('auto-upload');
                indicator.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> è‡ªå‹•ä¸Šå‚³ä¸­...';
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            }
        };

        // ğŸ¯ ä¿®å¾©é‡é»ï¼šå…ˆè§£æ URL åƒæ•¸å†åˆå§‹åŒ–
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                project: params.get('project'),
                layer: params.get('layer'),
                gist: params.get('gist')
            };
        }

        // å¾ URL åƒæ•¸æˆ–é è¨­å€¼ç²å–åˆå§‹å°ˆæ¡ˆ
        const urlParams = parseUrlParams();
        const initialProject = urlParams.project || '2.6.1';
        const initialLayer = urlParams.layer || 'main';

        // å…¨åŸŸè®Šæ•¸ - ä½¿ç”¨ URL åƒæ•¸ä½œç‚ºåˆå§‹å€¼
        let app = {
            data: null,
            currentProject: initialProject,  // ğŸ¯ ä¿®å¾©ï¼šä½¿ç”¨ URL åƒæ•¸
            currentLayer: initialLayer,      // ğŸ¯ ä¿®å¾©ï¼šä½¿ç”¨ URL åƒæ•¸
            gistId: urlParams.gist || localStorage.getItem('gist_id') || null,
            token: localStorage.getItem('github_token') || '',
            noteMode: localStorage.getItem('note_mode') === 'true',
            fontSize: localStorage.getItem('font_size') || 'medium',  // å­—é«”å¤§å°è¨­å®š
            autoSaveInterval: null,  // è‡ªå‹•å„²å­˜è¨ˆæ™‚å™¨
            autoUploadInterval: null,  // ğŸ¯ æ–°å¢ï¼šè‡ªå‹•ä¸Šå‚³è¨ˆæ™‚å™¨
            autoUploadEnabled: localStorage.getItem('auto_upload_enabled') === 'true',  // ğŸ¯ æ–°å¢ï¼šæ˜¯å¦å•Ÿç”¨è‡ªå‹•ä¸Šå‚³
            autoUploadIntervalMinutes: parseInt(localStorage.getItem('auto_upload_interval')) || 10,  // ğŸ¯ æ–°å¢ï¼šä¸Šå‚³é–“éš”
            lastSaveTime: Date.now(),  // æœ€å¾Œå„²å­˜æ™‚é–“
            lastUploadTime: Date.now(),  // ğŸ¯ æ–°å¢ï¼šæœ€å¾Œä¸Šå‚³æ™‚é–“
            lastDataHash: null  // ğŸ¯ æ–°å¢ï¼šç”¨æ–¼æª¢æ¸¬è³‡æ–™è®Šæ›´
        };

        console.log('ğŸ¯ çµ‚æ¥µç‰ˆåˆå§‹åŒ– - å°ˆæ¡ˆ:', app.currentProject, 'å±¤ç´š:', app.currentLayer);

        // è¨ˆç®—è³‡æ–™é›œæ¹Šå€¼ï¼Œç”¨æ–¼æª¢æ¸¬è®Šæ›´
        function calculateDataHash(data) {
            return JSON.stringify(data).split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
        }

        // ğŸ¯ æ–°å¢ï¼šè‡ªå‹•ä¸Šå‚³ç®¡ç†å™¨
        const AutoUploadManager = {
            start: function() {
                if (!app.autoUploadEnabled || !app.token) {
                    console.log('è‡ªå‹•ä¸Šå‚³æœªå•Ÿç”¨æˆ–ç„¡ Token');
                    return;
                }

                if (app.autoUploadInterval) {
                    clearInterval(app.autoUploadInterval);
                }

                const intervalMs = app.autoUploadIntervalMinutes * 60 * 1000;
                console.log(`å•Ÿå‹•è‡ªå‹•ä¸Šå‚³ï¼Œé–“éš”: ${app.autoUploadIntervalMinutes} åˆ†é˜`);

                app.autoUploadInterval = setInterval(async () => {
                    if (!app.data) return;

                    // è¨ˆç®—ç•¶å‰è³‡æ–™é›œæ¹Šå€¼
                    const currentHash = calculateDataHash(app.data);
                    
                    // å¦‚æœè³‡æ–™æ²’æœ‰è®Šæ›´ï¼Œè·³éä¸Šå‚³
                    if (app.lastDataHash === currentHash) {
                        console.log('è³‡æ–™ç„¡è®Šæ›´ï¼Œè·³éè‡ªå‹•ä¸Šå‚³');
                        return;
                    }

                    console.log('æª¢æ¸¬åˆ°è³‡æ–™è®Šæ›´ï¼Œé–‹å§‹è‡ªå‹•ä¸Šå‚³...');
                    StorageManager.showUploadIndicator();
                    setSyncStatus('auto-upload', 'è‡ªå‹•ä¸Šå‚³ä¸­...');

                    try {
                        await this.performAutoUpload();
                        app.lastDataHash = currentHash;
                        app.lastUploadTime = Date.now();
                        console.log('âœ… è‡ªå‹•ä¸Šå‚³æˆåŠŸ');
                    } catch (error) {
                        console.error('âŒ è‡ªå‹•ä¸Šå‚³å¤±æ•—:', error);
                        setSyncStatus('error', 'è‡ªå‹•ä¸Šå‚³å¤±æ•—');
                        setTimeout(() => {
                            setSyncStatus('synced', 'å·²é€£æ¥');
                        }, 3000);
                    }
                }, intervalMs);
            },

            stop: function() {
                if (app.autoUploadInterval) {
                    clearInterval(app.autoUploadInterval);
                    app.autoUploadInterval = null;
                    console.log('è‡ªå‹•ä¸Šå‚³å·²åœæ­¢');
                }
            },

            performAutoUpload: async function() {
                if (!app.token || !app.data) {
                    throw new Error('ç¼ºå°‘ Token æˆ–è³‡æ–™');
                }

                const dataToSave = {
                    ...app.data,
                    updatedAt: new Date().toISOString()
                };

                const body = {
                    description: `æ›¼é™€ç¾…å°ˆæ¡ˆç®¡ç†ç³»çµ±è³‡æ–™ - ${app.currentProject} (è‡ªå‹•ä¸Šå‚³)`,
                    public: false,
                    files: {
                        'mandala_data.json': {
                            content: JSON.stringify(dataToSave, null, 2)
                        }
                    }
                };

                const isCreate = !app.gistId;
                const url = isCreate ? 'https://api.github.com/gists' : `https://api.github.com/gists/${app.gistId}`;
                const method = isCreate ? 'POST' : 'PATCH';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `token ${app.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (isCreate) {
                        app.gistId = result.id;
                        localStorage.setItem('gist_id', app.gistId);
                    }
                    setSyncStatus('synced', 'è‡ªå‹•åŒæ­¥');
                    setTimeout(() => {
                        setSyncStatus('synced', 'å·²é€£æ¥');
                    }, 2000);
                } else {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
            }
        };

        // å­—é«”å¤§å°æ§åˆ¶å‡½æ•¸
        function setFontSize(size) {
            app.fontSize = size;
            localStorage.setItem('font_size', size);
            
            const container = document.getElementById('mainContainer');
            container.className = container.className.replace(/font-size-\w+/, '') + ` font-size-${size}`;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.font-size-controls button').forEach(btn => {
                btn.classList.remove('font-active');
            });
            document.getElementById(`font${size.charAt(0).toUpperCase() + size.slice(1)}`).classList.add('font-active');
            
            console.log('å­—é«”å¤§å°å·²æ›´æ–°ç‚º:', size);
        }

        // åˆå§‹åŒ–å­—é«”å¤§å°
        function initFontSize() {
            setFontSize(app.fontSize);
        }

        // è³‡æ–™çµæ§‹åˆå§‹åŒ–
        function createEmptyData() {
            const series = ['2.6','2.7','2.8','2.9'];
            const types = ['1','2','3','4','5','6','7'];
            const typeNames = ['ç›®æ¨™','é˜»ç¤™','åŠªåŠ›','çµæœ','æ„å¤–','è½‰å½','çµå±€'];
            const projects = {};
            
            series.forEach(s => {
                types.forEach((t, index) => {
                    const id = `${s}.${t}`;
                    projects[id] = {
                        title: `${id} ${typeNames[index]}`,
                        cells: {
                            CENTER: '',
                            F: '', C: '', G: '', B: '', D: '', E: '', A: '', H: '',
                            // å­å±¤ F1-F8, C1-C8, G1-G8, B1-B8, D1-D8, E1-E8, A1-A8, H1-H8
                            F1: '', F2: '', F3: '', F4: '', F5: '', F6: '', F7: '', F8: '',
                            C1: '', C2: '', C3: '', C4: '', C5: '', C6: '', C7: '', C8: '',
                            G1: '', G2: '', G3: '', G4: '', G5: '', G6: '', G7: '', G8: '',
                            B1: '', B2: '', B3: '', B4: '', B5: '', B6: '', B7: '', B8: '',
                            D1: '', D2: '', D3: '', D4: '', D5: '', D6: '', D7: '', D8: '',
                            E1: '', E2: '', E3: '', E4: '', E5: '', E6: '', E7: '', E8: '',
                            A1: '', A2: '', A3: '', A4: '', A5: '', A6: '', A7: '', A8: '',
                            H1: '', H2: '', H3: '', H4: '', H5: '', H6: '', H7: '', H8: ''
                        },
                        history: []
                    };
                });
            });

            return {
                version: '2.2',  // ç‰ˆæœ¬å‡ç´šåˆ°çµ‚æ¥µç‰ˆ
                updatedAt: new Date().toISOString(),
                meta: {
                    activeProject: app.currentProject,
                    noteMode: app.noteMode,
                    fontSize: app.fontSize,
                    autoUpload: app.autoUploadEnabled,
                    autoUploadInterval: app.autoUploadIntervalMinutes,
                    schema: 'mandala-ultimate-v2.2'  // çµ‚æ¥µç‰ˆæœ¬æ¨™è¨˜
                },
                projects: projects
            };
        }

        // ç‰ˆæœ¬é·ç§»
        function migrateToV2(data) {
            if (!data.version || data.version === '1.0') {
                // èˆŠç‰ˆæœ¬é·ç§»é‚è¼¯
                const newData = createEmptyData();
                if (data.projects) {
                    Object.keys(data.projects).forEach(projectId => {
                        if (newData.projects[projectId]) {
                            const oldProject = data.projects[projectId];
                            if (oldProject.data) {
                                // é·ç§»èˆŠçš„9æ ¼è³‡æ–™åˆ°æ–°çµæ§‹
                                Object.keys(oldProject.data).forEach(cell => {
                                    if (newData.projects[projectId].cells[cell] !== undefined) {
                                        newData.projects[projectId].cells[cell] = oldProject.data[cell];
                                    }
                                });
                            }
                            newData.projects[projectId].title = oldProject.name || newData.projects[projectId].title;
                        }
                    });
                }
                return newData;
            }
            
            // æ–°å¢åŠŸèƒ½è¨­å®šçš„é·ç§»
            if (data.meta) {
                if (data.meta.fontSize) {
                    app.fontSize = data.meta.fontSize;
                    localStorage.setItem('font_size', app.fontSize);
                }
                if (data.meta.autoUpload !== undefined) {
                    app.autoUploadEnabled = data.meta.autoUpload;
                    localStorage.setItem('auto_upload_enabled', app.autoUploadEnabled);
                }
                if (data.meta.autoUploadInterval) {
                    app.autoUploadIntervalMinutes = data.meta.autoUploadInterval;
                    localStorage.setItem('auto_upload_interval', app.autoUploadIntervalMinutes);
                }
            }
            
            // å‡ç´šåˆ°çµ‚æ¥µç‰ˆæœ¬
            if (!data.meta.schema || !data.meta.schema.includes('ultimate')) {
                data.version = '2.2';
                data.meta.schema = 'mandala-ultimate-v2.2';
                data.meta.autoUpload = app.autoUploadEnabled;
                data.meta.autoUploadInterval = app.autoUploadIntervalMinutes;
                console.log('å‡ç´šåˆ°çµ‚æ¥µç‰ˆæœ¬');
            }
            
            return data;
        }

        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šå¼·åŒ–çš„è³‡æ–™åˆå§‹åŒ–
        function initData() {
            console.log('ğŸ¯ çµ‚æ¥µç‰ˆï¼šæ­£åœ¨åˆå§‹åŒ–è³‡æ–™...ç•¶å‰å°ˆæ¡ˆ:', app.currentProject);
            
            // å˜—è©¦å¾å¤šå€‹å„²å­˜ä½ç½®è¼‰å…¥
            const loadedData = StorageManager.load();
            
            if (loadedData) {
                try {
                    app.data = migrateToV2(loadedData);
                    console.log('âœ… çµ‚æ¥µç‰ˆï¼šè³‡æ–™è¼‰å…¥æˆåŠŸ');
                } catch (e) {
                    console.error('âŒ è³‡æ–™è¼‰å…¥å¤±æ•—:', e);
                    app.data = createEmptyData();
                }
            } else {
                console.log('ğŸ†• å»ºç«‹æ–°çš„ç©ºç™½è³‡æ–™');
                app.data = createEmptyData();
            }
            
            // åˆå§‹åŒ–å­—é«”å¤§å°
            initFontSize();
            
            // ğŸ¯ ä¿®å¾©ï¼šç¢ºä¿è¼‰å…¥æ­£ç¢ºçš„å°ˆæ¡ˆ
            console.log('è¼‰å…¥å°ˆæ¡ˆ:', app.currentProject);
            loadProject(app.currentProject, false); // ä¸æ›´æ–° URL
            
            // ğŸ¯ çµ‚æ¥µç‰ˆï¼šå•Ÿå‹•è‡ªå‹•å„²å­˜å’Œè‡ªå‹•ä¸Šå‚³
            startAutoSave();
            if (app.autoUploadEnabled && app.token) {
                AutoUploadManager.start();
            }

            // è¨ˆç®—åˆå§‹è³‡æ–™é›œæ¹Šå€¼
            app.lastDataHash = calculateDataHash(app.data);
        }

        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šè‡ªå‹•å„²å­˜æ©Ÿåˆ¶
        function startAutoSave() {
            // æ¯10ç§’è‡ªå‹•å„²å­˜ä¸€æ¬¡
            if (app.autoSaveInterval) {
                clearInterval(app.autoSaveInterval);
            }
            
            app.autoSaveInterval = setInterval(() => {
                if (Date.now() - app.lastSaveTime > 8000) { // 8ç§’å…§æ²’æœ‰æ‰‹å‹•å„²å­˜æ‰è‡ªå‹•å„²å­˜
                    saveToStorage(false); // ä¸é¡¯ç¤ºæŒ‡ç¤ºå™¨çš„è‡ªå‹•å„²å­˜
                    setSyncStatus('auto-save', 'è‡ªå‹•å„²å­˜');
                    setTimeout(() => {
                        if (app.token) {
                            setSyncStatus('synced', 'å·²é€£æ¥');
                        } else {
                            setSyncStatus('offline', 'é›¢ç·š');
                        }
                    }, 1000);
                }
            }, 10000);
            
            console.log('ğŸ¯ çµ‚æ¥µç‰ˆï¼šè‡ªå‹•å„²å­˜å·²å•Ÿå‹•');
        }

        // è¼‰å…¥å°ˆæ¡ˆ - ğŸ¯ ä¿®å¾©ï¼šæ–°å¢ updateUrl åƒæ•¸
        function loadProject(projectId, updateUrl = true) {
            console.log('è¼‰å…¥å°ˆæ¡ˆ:', projectId);
            if (!app.data || !app.data.projects[projectId]) {
                console.error('å°ˆæ¡ˆä¸å­˜åœ¨:', projectId, 'å¯ç”¨å°ˆæ¡ˆ:', Object.keys(app.data?.projects || {}));
                return;
            }
            
            app.currentProject = projectId;
            app.currentLayer = 'main';
            app.data.meta.activeProject = projectId;
            
            updateProjectTitle();
            updateBreadcrumb();
            renderMainLayer();
            updateActiveProject();
            
            if (updateUrl) {
                syncUrl(false);
            }
            
            console.log('å°ˆæ¡ˆè¼‰å…¥å®Œæˆ:', projectId);
        }

        // æ›´æ–°å°ˆæ¡ˆæ¨™é¡Œ
        function updateProjectTitle() {
            const project = app.data.projects[app.currentProject];
            document.getElementById('projectTitle').textContent = project.title;
        }

        // æ›´æ–°éºµåŒ…å±‘
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            if (app.currentLayer === 'main') {
                breadcrumb.textContent = 'ä¸»å±¤';
            } else {
                breadcrumb.textContent = `ä¸»å±¤ > ${app.currentLayer} å­å±¤`;
            }
        }

        // æ¸²æŸ“ä¸»å±¤
        function renderMainLayer() {
            const grid = document.getElementById('mandalaGrid');
            const project = app.data.projects[app.currentProject];
            
            grid.innerHTML = `
                <div class="grid-cell" data-position="F" onclick="enterLayer('F')">
                    <div class="cell-label">F</div>
                    <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="F" onclick="event.stopPropagation()">${project.cells.F || ''}</textarea>
                </div>
                <div class="grid-cell" data-position="C" onclick="enterLayer('C')">
                    <div class="cell-label">C</div>
                    <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="C" onclick="event.stopPropagation()">${project.cells.C || ''}</textarea>
                </div>
                <div class="grid-cell" data-position="G" onclick="enterLayer('G')">
                    <div class="cell-label">G</div>
                    <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="G" onclick="event.stopPropagation()">${project.cells.G || ''}</textarea>
                </div>
                <div class="grid-cell" data-position="B" onclick="enterLayer('B')">
                    <div class="cell-label">B</div>
                    <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="B" onclick="event.stopPropagation()">${project.cells.B || ''}</textarea>
                </div>
                <div class="grid-cell center" data-position="CENTER">
                    <div class="cell-label">ä¸­å¿ƒ</div>
                    <textarea class="cell-content" placeholder="å°ˆæ¡ˆæ ¸å¿ƒä¸»é¡Œ..." data-cell="CENTER">${project.cells.CENTER || ''}</textarea>
                </div>
                <div class="grid-cell" data-position="D" onclick="enterLayer('D')">
                    <div class="cell-label">D</div>
                    <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="D" onclick="event.stopPropagation()">${project.cells.D || ''}</textarea>
                </div>
                <div class="grid-cell" data-position="E" onclick="enterLayer('E')">
                    <div class="cell-label">E</div>
                    <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="E" onclick="event.stopPropagation()">${project.cells.E || ''}</textarea>
                </div>
                <div class="grid-cell" data-position="A" onclick="enterLayer('A')">
                    <div class="cell-label">A</div>
                    <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="A" onclick="event.stopPropagation()">${project.cells.A || ''}</textarea>
                </div>
                <div class="grid-cell" data-position="H" onclick="enterLayer('H')">
                    <div class="cell-label">H</div>
                    <textarea class="cell-content" placeholder="é»æ“Šå±•é–‹æ€ç¶­..." data-cell="H" onclick="event.stopPropagation()">${project.cells.H || ''}</textarea>
                </div>
            `;
            
            bindTextareaEvents();
        }

        // é€²å…¥å­å±¤
        function enterLayer(layer) {
            app.currentLayer = layer;
            updateBreadcrumb();
            renderSubLayer(layer);
            syncUrl(true);
        }

        // æ¸²æŸ“å­å±¤
        function renderSubLayer(layer) {
            const grid = document.getElementById('mandalaGrid');
            const project = app.data.projects[app.currentProject];
            
            // å­å±¤æ’åˆ—ï¼š6-3-7 / 2-ä¸­å¿ƒ-4 / 5-1-8
            grid.innerHTML = `
                <div class="grid-cell sub-layer" data-position="${layer}6">
                    <div class="cell-label">${layer}6</div>
                    <textarea class="cell-content" placeholder="è¼¸å…¥å…§å®¹..." data-cell="${layer}6">${project.cells[layer + '6'] || ''}</textarea>
                </div>
                <div class="grid-cell sub-layer" data-position="${layer}3">
                    <div class="cell-label">${layer}3</div>
                    <textarea class="cell-content" placeholder="è¼¸å…¥å…§å®¹..." data-cell="${layer}3">${project.cells[layer + '3'] || ''}</textarea>
                </div>
                <div class="grid-cell sub-layer" data-position="${layer}7">
                    <div class="cell-label">${layer}7</div>
                    <textarea class="cell-content" placeholder="è¼¸å…¥å…§å®¹..." data-cell="${layer}7">${project.cells[layer + '7'] || ''}</textarea>
                </div>
                <div class="grid-cell sub-layer" data-position="${layer}2">
                    <div class="cell-label">${layer}2</div>
                    <textarea class="cell-content" placeholder="è¼¸å…¥å…§å®¹..." data-cell="${layer}2">${project.cells[layer + '2'] || ''}</textarea>
                </div>
                <div class="grid-cell sub-center" data-position="${layer}_CENTER" onclick="returnToMain()">
                    <div class="cell-label">${layer} å€åŸŸ</div>
                    <textarea class="cell-content" placeholder="æ­¤å€åŸŸä¸»é¡Œ..." data-cell="${layer}" readonly>${project.cells[layer] || ''}</textarea>
                </div>
                <div class="grid-cell sub-layer" data-position="${layer}4">
                    <div class="cell-label">${layer}4</div>
                    <textarea class="cell-content" placeholder="è¼¸å…¥å…§å®¹..." data-cell="${layer}4">${project.cells[layer + '4'] || ''}</textarea>
                </div>
                <div class="grid-cell sub-layer" data-position="${layer}5">
                    <div class="cell-label">${layer}5</div>
                    <textarea class="cell-content" placeholder="è¼¸å…¥å…§å®¹..." data-cell="${layer}5">${project.cells[layer + '5'] || ''}</textarea>
                </div>
                <div class="grid-cell sub-layer" data-position="${layer}1">
                    <div class="cell-label">${layer}1</div>
                    <textarea class="cell-content" placeholder="è¼¸å…¥å…§å®¹..." data-cell="${layer}1">${project.cells[layer + '1'] || ''}</textarea>
                </div>
                <div class="grid-cell sub-layer" data-position="${layer}8">
                    <div class="cell-label">${layer}8</div>
                    <textarea class="cell-content" placeholder="è¼¸å…¥å…§å®¹..." data-cell="${layer}8">${project.cells[layer + '8'] || ''}</textarea>
                </div>
            `;
            
            bindTextareaEvents();
        }

        // è¿”å›ä¸»å±¤
        function returnToMain() {
            app.currentLayer = 'main';
            updateBreadcrumb();
            renderMainLayer();
            syncUrl(true);
        }

        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šå¼·åŒ–çš„æ–‡å­—æ¡†äº‹ä»¶ç¶å®š
        function bindTextareaEvents() {
            document.querySelectorAll('.cell-content').forEach(textarea => {
                // ğŸ¯ çµ‚æ¥µç‰ˆï¼šæ›´é »ç¹çš„å³æ™‚å„²å­˜
                textarea.addEventListener('input', function() {
                    const cell = this.getAttribute('data-cell');
                    if (cell && app.data.projects[app.currentProject]) {
                        app.data.projects[app.currentProject].cells[cell] = this.value;
                        
                        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šç«‹å³å„²å­˜åˆ° sessionStorage
                        try {
                            sessionStorage.setItem(StorageManager.keys.session, JSON.stringify(app.data));
                        } catch (e) {
                            console.warn('å³æ™‚å„²å­˜å¤±æ•—:', e);
                        }
                        
                        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šæ¸›å°‘é˜²æŠ–æ™‚é–“ï¼ˆå¾800msé™åˆ°300msï¼‰
                        clearTimeout(this.saveTimeout);
                        this.saveTimeout = setTimeout(() => {
                            saveToStorage(true);
                        }, 300);
                    }
                });

                // ğŸ¯ çµ‚æ¥µç‰ˆï¼šéµç›¤äº‹ä»¶ä¹Ÿè§¸ç™¼å„²å­˜
                textarea.addEventListener('keydown', function(e) {
                    // ç­†è¨˜æ¨¡å¼è™•ç†
                    if (app.noteMode) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            const pos = this.selectionStart;
                            const value = this.value;
                            const newValue = value.substring(0, pos) + '\n- ' + value.substring(this.selectionEnd);
                            this.value = newValue;
                            this.selectionStart = this.selectionEnd = pos + 3;
                            this.dispatchEvent(new Event('input'));
                        }
                        
                        if (e.key === ';' && (e.ctrlKey || e.metaKey)) {
                            e.preventDefault();
                            const pos = this.selectionStart;
                            const date = new Date().toISOString().split('T')[0];
                            const value = this.value;
                            const newValue = value.substring(0, pos) + date + value.substring(this.selectionEnd);
                            this.value = newValue;
                            this.selectionStart = this.selectionEnd = pos + date.length;
                            this.dispatchEvent(new Event('input'));
                        }
                    }
                    
                    // ğŸ¯ çµ‚æ¥µç‰ˆï¼šç‰¹æ®Šéµè§¸ç™¼ç«‹å³å„²å­˜
                    if (e.key === 'Enter' || e.key === 'Tab' || (e.ctrlKey && e.key === 's')) {
                        if (e.ctrlKey && e.key === 's') {
                            e.preventDefault();
                        }
                        // ç«‹å³å„²å­˜
                        const cell = this.getAttribute('data-cell');
                        if (cell && app.data.projects[app.currentProject]) {
                            app.data.projects[app.currentProject].cells[cell] = this.value;
                            saveToStorage(true);
                        }
                    }
                });

                // ğŸ¯ çµ‚æ¥µç‰ˆï¼šå¤±å»ç„¦é»æ™‚ç«‹å³å„²å­˜
                textarea.addEventListener('blur', function() {
                    const cell = this.getAttribute('data-cell');
                    if (cell && app.data.projects[app.currentProject]) {
                        app.data.projects[app.currentProject].cells[cell] = this.value;
                        saveToStorage(false); // ä¸é¡¯ç¤ºæŒ‡ç¤ºå™¨
                    }
                });
            });
        }

        // æ›´æ–°æ´»å‹•å°ˆæ¡ˆ
        function updateActiveProject() {
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`[data-project="${app.currentProject}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                console.log('è¨­å®šæ´»å‹•å°ˆæ¡ˆè¦–è¦ºç‹€æ…‹:', app.currentProject);
            }
        }

        // URL åŒæ­¥åŠŸèƒ½
        function syncUrl(replace) {
            try {
                const params = new URLSearchParams(window.location.search);
                if (app.currentProject) {
                    params.set('project', app.currentProject);
                }
                if (app.currentLayer) {
                    params.set('layer', app.currentLayer === 'main' ? 'main' : app.currentLayer);
                }
                if (app.gistId) {
                    params.set('gist', app.gistId);
                } else {
                    params.delete('gist');
                }
                const url = window.location.pathname + '?' + params.toString();
                history[replace ? 'replaceState' : 'pushState']({}, '', url);
                console.log('URL å·²æ›´æ–°:', url);
            } catch(e) {
                console.warn('syncUrl failed', e);
            }
        }

        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šå¼·åŒ–çš„å„²å­˜å‡½æ•¸
        function saveToStorage(showIndicator = true) {
            if (!app.data) return false;
            
            app.data.updatedAt = new Date().toISOString();
            app.data.meta.fontSize = app.fontSize;
            app.data.meta.autoUpload = app.autoUploadEnabled;
            app.data.meta.autoUploadInterval = app.autoUploadIntervalMinutes;
            app.lastSaveTime = Date.now();
            
            const success = StorageManager.save(app.data, showIndicator);
            
            if (success) {
                console.log('ğŸ¯ çµ‚æ¥µç‰ˆï¼šå¤šé‡å„²å­˜æˆåŠŸ');
            } else {
                console.error('âŒ æ‰€æœ‰å„²å­˜ä½ç½®éƒ½å¤±æ•—');
            }
            
            return success;
        }

        // ç›¸å®¹æ€§ï¼šä¿æŒåŸæœ‰å‡½æ•¸åç¨±
        function saveToLocalStorage() {
            return saveToStorage(true);
        }

        // æœ¬åœ°å„²å­˜
        function saveLocal() {
            const success = saveToStorage(true);
            if (success) {
                setSyncStatus('synced', 'å·²å„²å­˜');
                setTimeout(() => {
                    if (app.token) {
                        setSyncStatus('synced', 'å·²é€£æ¥');
                    } else {
                        setSyncStatus('offline', 'é›¢ç·š');
                    }
                }, 1500);
            } else {
                setSyncStatus('error', 'å„²å­˜å¤±æ•—');
            }
        }

        // æœ¬åœ°è¼‰å…¥
        function loadLocal() {
            const loadedData = StorageManager.load();
            if (!loadedData) {
                alert('æ‰¾ä¸åˆ°æœ¬åœ°å‚™ä»½è³‡æ–™');
                return;
            }
            
            try {
                app.data = migrateToV2(loadedData);
                loadProject(app.currentProject);
                alert('æœ¬åœ°è³‡æ–™è¼‰å…¥æˆåŠŸ');
            } catch (e) {
                alert('æœ¬åœ°è³‡æ–™æ ¼å¼éŒ¯èª¤');
            }
        }

        // JSON åŒ¯å‡º
        function exportJSON() {
            const blob = new Blob([JSON.stringify(app.data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0] + '_' + 
                            new Date().toTimeString().split(' ')[0].replace(/:/g, '');
            a.href = url;
            a.download = `mandala_${app.currentProject}_${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // JSON åŒ¯å…¥
        function importJSONFile() {
            document.getElementById('importJSONInput').click();
        }

        function handleJSONImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    app.data = migrateToV2(data);
                    saveToStorage(true);
                    loadProject(app.currentProject);
                    alert('JSON åŒ¯å…¥æˆåŠŸ');
                } catch (error) {
                    alert('JSON æª”æ¡ˆæ ¼å¼éŒ¯èª¤: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // OPML åŒ¯å‡º
        function exportOPML() {
            const project = app.data.projects[app.currentProject];
            const now = new Date();
            const timestamp = now.toISOString();
            
            let opml = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
    <head>
        <title>æ›¼é™€ç¾…å°ˆæ¡ˆ: ${project.title}</title>
        <dateCreated>${timestamp}</dateCreated>
        <generator>æ›¼é™€ç¾…å°ˆæ¡ˆç®¡ç†ç³»çµ± v3.6 - çµ‚æ¥µå®Œæ•´ç‰ˆ</generator>
    </head>
    <body>
        <outline text="ä¸­å¿ƒä¸»é¡Œ: ${escapeXml(project.cells.CENTER)}">`;

            // ä¸»å±¤ A-Hï¼Œæ¯å€‹åŒ…å« 1-8 å­å±¤
            const mainCells = ['F', 'C', 'G', 'B', 'D', 'E', 'A', 'H'];
            mainCells.forEach(cell => {
                opml += `
            <outline text="${cell}: ${escapeXml(project.cells[cell])}">`;
                
                // å­å±¤ 1-8
                for (let i = 1; i <= 8; i++) {
                    const subCell = cell + i;
                    opml += `
                <outline text="${subCell}: ${escapeXml(project.cells[subCell] || '')}"/>`;
                }
                
                opml += `
            </outline>`;
            });

            opml += `
        </outline>
    </body>
</opml>`;

            const blob = new Blob([opml], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const fileTimestamp = now.toISOString().replace(/[:.]/g, '-').split('T')[0] + '_' + 
                                now.toTimeString().split(' ')[0].replace(/:/g, '');
            a.href = url;
            a.download = `mandala_${app.currentProject}_${fileTimestamp}.opml`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // OPML åŒ¯å…¥
        function importOPML() {
            document.getElementById('importOPMLInput').click();
        }

        function handleOPMLImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(e.target.result, 'text/xml');
                    
                    // æª¢æŸ¥éŒ¯èª¤
                    const parseError = xml.querySelector('parsererror');
                    if (parseError) {
                        throw new Error('XML æ ¼å¼éŒ¯èª¤');
                    }
                    
                    const project = app.data.projects[app.currentProject];
                    const outlines = xml.querySelectorAll('outline');
                    
                    // è§£æ OPML çµæ§‹
                    outlines.forEach(outline => {
                        const text = outline.getAttribute('text') || '';
                        const colonIndex = text.indexOf(':');
                        
                        if (colonIndex > 0) {
                            const key = text.substring(0, colonIndex).trim();
                            const value = text.substring(colonIndex + 1).trim();
                            
                            // ä¸­å¿ƒä¸»é¡Œ
                            if (key === 'ä¸­å¿ƒä¸»é¡Œ') {
                                project.cells.CENTER = value;
                            }
                            // ä¸»å±¤ A-H
                            else if (['F','C','G','B','D','E','A','H'].includes(key)) {
                                project.cells[key] = value;
                                
                                // æŸ¥æ‰¾å­å±¤
                                const subOutlines = outline.querySelectorAll('outline');
                                subOutlines.forEach(subOutline => {
                                    const subText = subOutline.getAttribute('text') || '';
                                    const subColonIndex = subText.indexOf(':');
                                    if (subColonIndex > 0) {
                                        const subKey = subText.substring(0, subColonIndex).trim();
                                        const subValue = subText.substring(subColonIndex + 1).trim();
                                        if (project.cells[subKey] !== undefined) {
                                            project.cells[subKey] = subValue;
                                        }
                                    }
                                });
                            }
                            // ç›´æ¥çš„å­å±¤æ ¼å­ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
                            else if (project.cells[key] !== undefined) {
                                project.cells[key] = value;
                            }
                        }
                    });
                    
                    saveToStorage(true);
                    if (app.currentLayer === 'main') {
                        renderMainLayer();
                    } else {
                        renderSubLayer(app.currentLayer);
                    }
                    
                    alert('OPML åŒ¯å…¥æˆåŠŸ');
                } catch (error) {
                    alert('OPML åŒ¯å…¥å¤±æ•—: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // XML è½‰ç¾©
        function escapeXml(str) {
            return (str || '').replace(/[&<>"']/g, s => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                "\"": "&quot;",
                "'": "&apos;"
            }[s]));
        }

        // GitHub Gist ä¸Šå‚³
        async function uploadGist() {
            if (!app.token) {
                alert('è«‹å…ˆè¨­å®š GitHub Token');
                showGitHubModal();
                return;
            }

            setSyncStatus('syncing', 'ä¸Šå‚³ä¸­...');
            
            try {
                const dataToSave = {
                    ...app.data,
                    updatedAt: new Date().toISOString()
                };

                const body = {
                    description: `æ›¼é™€ç¾…å°ˆæ¡ˆç®¡ç†ç³»çµ±è³‡æ–™ - ${app.currentProject} (çµ‚æ¥µç‰ˆ)`,
                    public: false,
                    files: {
                        'mandala_data.json': {
                            content: JSON.stringify(dataToSave, null, 2)
                        }
                    }
                };

                const isCreate = !app.gistId;
                const url = isCreate ? 'https://api.github.com/gists' : `https://api.github.com/gists/${app.gistId}`;
                const method = isCreate ? 'POST' : 'PATCH';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `token ${app.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const result = await response.json();
                    app.gistId = result.id;
                    localStorage.setItem('gist_id', app.gistId);
                    saveToStorage(true);
                    setSyncStatus('synced', 'å·²åŒæ­¥');
                    
                    // æ›´æ–°è³‡æ–™é›œæ¹Šå€¼
                    app.lastDataHash = calculateDataHash(app.data);
                    app.lastUploadTime = Date.now();
                    
                    // é¡¯ç¤ºåˆ†äº«è³‡è¨Š
                    const shareUrl = `${window.location.origin}${window.location.pathname}?gist=${app.gistId}`;
                    alert(`ä¸Šå‚³æˆåŠŸï¼\nè·¨ç€è¦½å™¨åˆ†äº«ç¶²å€ï¼š\n${shareUrl}`);
                } else {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
            } catch (error) {
                console.error('ä¸Šå‚³å¤±æ•—:', error);
                setSyncStatus('error', 'ä¸Šå‚³å¤±æ•—');
                saveToStorage(true); // æœ¬åœ°å‚™ä»½
                alert('ä¸Šå‚³å¤±æ•—: ' + error.message);
            }
        }

        // GitHub Gist ä¸‹è¼‰
        async function downloadGist() {
            if (!app.token) {
                alert('è«‹å…ˆè¨­å®š GitHub Token');
                showGitHubModal();
                return;
            }

            const gistId = app.gistId || document.getElementById('gistId').value.trim();
            if (!gistId) {
                alert('è«‹æä¾› Gist ID');
                showGitHubModal();
                return;
            }

            setSyncStatus('syncing', 'ä¸‹è¼‰ä¸­...');

            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `token ${app.token}`
                    }
                });

                if (response.ok) {
                    const gist = await response.json();
                    const content = gist.files['mandala_data.json']?.content;
                    
                    if (!content) {
                        throw new Error('Gist ä¸­æ‰¾ä¸åˆ° mandala_data.json æª”æ¡ˆ');
                    }
                    
                    const data = JSON.parse(content);
                    app.data = migrateToV2(data);
                    app.gistId = gistId;
                    localStorage.setItem('gist_id', gistId);
                    saveToStorage(true);
                    
                    // æ›´æ–°è³‡æ–™é›œæ¹Šå€¼
                    app.lastDataHash = calculateDataHash(app.data);
                    
                    loadProject(app.currentProject);
                    setSyncStatus('synced', 'å·²åŒæ­¥');
                    alert('ä¸‹è¼‰æˆåŠŸ');
                } else {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
            } catch (error) {
                console.error('ä¸‹è¼‰å¤±æ•—:', error);
                setSyncStatus('error', 'ä¸‹è¼‰å¤±æ•—');
                alert('ä¸‹è¼‰å¤±æ•—: ' + error.message);
            }
        }

        // åˆ†äº« Gist
        function shareGist() {
            if (!app.gistId) {
                alert('è«‹å…ˆä¸Šå‚³è³‡æ–™åˆ° GitHub');
                return;
            }
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?gist=${app.gistId}&project=${encodeURIComponent(app.currentProject)}&layer=${encodeURIComponent(app.currentLayer)}`;
            
            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert(`åˆ†äº«ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼š\n${shareUrl}`);
                }).catch(() => {
                    showShareUrl(shareUrl);
                });
            } else {
                showShareUrl(shareUrl);
            }
        }

        function showShareUrl(url) {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert(`åˆ†äº«ç¶²å€ï¼š\n${url}\n\n(å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿)`);
        }

        // æ¸…é™¤ A-H
        function clearAH() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤ç•¶å‰å°ˆæ¡ˆçš„ A-H æ ¼å­å…§å®¹å—ï¼Ÿ')) return;
            
            const project = app.data.projects[app.currentProject];
            const cells = ['F','C','G','B','D','E','A','H'];
            
            cells.forEach(cell => {
                project.cells[cell] = '';
                // æ¸…é™¤å°æ‡‰çš„å­å±¤
                for (let i = 1; i <= 8; i++) {
                    project.cells[cell + i] = '';
                }
            });
            
            saveToStorage(true);
            if (app.currentLayer === 'main') {
                renderMainLayer();
            } else {
                renderSubLayer(app.currentLayer);
            }
        }

        // æ¸…é™¤å…¨éƒ¨
        function clearAll() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤ç•¶å‰å°ˆæ¡ˆçš„æ‰€æœ‰å…§å®¹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
            
            const project = app.data.projects[app.currentProject];
            Object.keys(project.cells).forEach(cell => {
                project.cells[cell] = '';
            });
            
            saveToStorage(true);
            if (app.currentLayer === 'main') {
                renderMainLayer();
            } else {
                renderSubLayer(app.currentLayer);
            }
        }

        // åŒæ­¥ç‹€æ…‹
        function setSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = `sync-status ${status}`;
            statusEl.querySelector('span').textContent = text;
        }

        // å´é‚Šæ¬„åˆ‡æ›
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // GitHub æ¨¡æ…‹æ¡†
        function showGitHubModal() {
            document.getElementById('githubToken').value = app.token;
            document.getElementById('gistId').value = app.gistId || '';
            document.getElementById('noteModeToggle').checked = app.noteMode;
            document.getElementById('autoUploadToggle').checked = app.autoUploadEnabled;
            document.getElementById('autoUploadInterval').value = app.autoUploadIntervalMinutes;
            
            // æ ¹æ“šè‡ªå‹•ä¸Šå‚³é–‹é—œé¡¯ç¤º/éš±è—é–“éš”è¨­å®š
            const intervalGroup = document.getElementById('autoUploadIntervalGroup');
            intervalGroup.style.display = app.autoUploadEnabled ? 'block' : 'none';
            
            document.getElementById('githubModal').style.display = 'block';
        }

        function closeGitHubModal() {
            document.getElementById('githubModal').style.display = 'none';
        }

        function saveGitHubConfig() {
            app.token = document.getElementById('githubToken').value.trim();
            app.gistId = document.getElementById('gistId').value.trim() || null;
            app.noteMode = document.getElementById('noteModeToggle').checked;
            app.autoUploadEnabled = document.getElementById('autoUploadToggle').checked;
            app.autoUploadIntervalMinutes = parseInt(document.getElementById('autoUploadInterval').value);
            
            if (app.token) {
                localStorage.setItem('github_token', app.token);
                setSyncStatus('synced', 'å·²é€£æ¥');
            } else {
                localStorage.removeItem('github_token');
                setSyncStatus('offline', 'é›¢ç·š');
            }
            
            if (app.gistId) {
                localStorage.setItem('gist_id', app.gistId);
            } else {
                localStorage.removeItem('gist_id');
            }
            
            localStorage.setItem('note_mode', app.noteMode);
            localStorage.setItem('auto_upload_enabled', app.autoUploadEnabled);
            localStorage.setItem('auto_upload_interval', app.autoUploadIntervalMinutes);
            
            // æ›´æ–° app.data ä¸­çš„è¨­å®š
            app.data.meta.noteMode = app.noteMode;
            app.data.meta.autoUpload = app.autoUploadEnabled;
            app.data.meta.autoUploadInterval = app.autoUploadIntervalMinutes;
            saveToStorage(true);
            
            // ğŸ¯ æ–°å¢ï¼šç®¡ç†è‡ªå‹•ä¸Šå‚³
            if (app.autoUploadEnabled && app.token) {
                console.log('å•Ÿå‹•è‡ªå‹•ä¸Šå‚³åŠŸèƒ½');
                AutoUploadManager.start();
            } else {
                console.log('åœæ­¢è‡ªå‹•ä¸Šå‚³åŠŸèƒ½');
                AutoUploadManager.stop();
            }
            
            closeGitHubModal();
        }

        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šå°ˆæ¡ˆé»æ“Šäº‹ä»¶è™•ç†å™¨
        function setupProjectClickHandlers() {
            console.log('ğŸ¯ çµ‚æ¥µç‰ˆï¼šè¨­å®šå°ˆæ¡ˆé»æ“Šäº‹ä»¶è™•ç†å™¨');
            
            // ç­–ç•¥ 1: äº‹ä»¶ä»£ç† (ä¸»è¦ç­–ç•¥)
            const projectList = document.getElementById('projectList');
            if (projectList) {
                // ç§»é™¤ç¾æœ‰çš„äº‹ä»¶ç›£è½å™¨
                const newProjectList = projectList.cloneNode(true);
                projectList.parentNode.replaceChild(newProjectList, projectList);
                
                // è¨­å®šæ–°çš„äº‹ä»¶ç›£è½å™¨
                newProjectList.addEventListener('click', function(e) {
                    console.log('äº‹ä»¶ä»£ç†é»æ“Š:', e.target);
                    
                    const item = e.target.closest('.project-item');
                    if (item) {
                        const projectId = item.getAttribute('data-project');
                        console.log('é€šéäº‹ä»¶ä»£ç†é»æ“Šå°ˆæ¡ˆ:', projectId);
                        if (projectId && projectId !== app.currentProject) {
                            loadProject(projectId);
                        }
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
                
                // ç­–ç•¥ 2: ç›´æ¥ç¶å®š (å‚™ç”¨ç­–ç•¥)
                setTimeout(() => {
                    document.querySelectorAll('.project-item').forEach((item, index) => {
                        // ç§»é™¤ç¾æœ‰äº‹ä»¶ç›£è½å™¨
                        const newItem = item.cloneNode(true);
                        item.parentNode.replaceChild(newItem, item);
                        
                        // å¤šç¨®äº‹ä»¶ç¶å®š
                        ['click', 'mousedown', 'touchstart'].forEach(eventType => {
                            newItem.addEventListener(eventType, function(e) {
                                const projectId = this.getAttribute('data-project');
                                console.log(`ç›´æ¥ç¶å®š ${eventType} äº‹ä»¶è§¸ç™¼:`, projectId);
                                if (projectId && projectId !== app.currentProject) {
                                    loadProject(projectId);
                                }
                                e.preventDefault();
                                e.stopPropagation();
                            });
                        });
                        
                        // ç­–ç•¥ 3: å¼·åˆ¶é»æ“Šå€åŸŸ (CSS + JS)
                        newItem.style.cursor = 'pointer';
                        newItem.style.userSelect = 'none';
                        newItem.style.position = 'relative';
                        
                        // æ·»åŠ éš±å½¢è¦†è“‹å±¤ç¢ºä¿é»æ“ŠéŸ¿æ‡‰
                        const overlay = document.createElement('div');
                        overlay.style.position = 'absolute';
                        overlay.style.top = '0';
                        overlay.style.left = '0';
                        overlay.style.right = '0';
                        overlay.style.bottom = '0';
                        overlay.style.zIndex = '2';
                        overlay.style.cursor = 'pointer';
                        
                        overlay.addEventListener('click', function(e) {
                            const projectId = newItem.getAttribute('data-project');
                            console.log('è¦†è“‹å±¤é»æ“Šè§¸ç™¼:', projectId);
                            if (projectId && projectId !== app.currentProject) {
                                loadProject(projectId);
                            }
                            e.preventDefault();
                            e.stopPropagation();
                        });
                        
                        newItem.appendChild(overlay);
                        
                        console.log(`å·²è¨­å®šå°ˆæ¡ˆé …ç›® ${index + 1}: ${newItem.getAttribute('data-project')}`);
                    });
                }, 100);
                
                console.log('âœ… å°ˆæ¡ˆé»æ“Šäº‹ä»¶è™•ç†å™¨è¨­å®šå®Œæˆ');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ° projectList å…ƒç´ ');
            }
        }

        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šDOMContentLoaded äº‹ä»¶ç›£è½
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¯ çµ‚æ¥µç‰ˆï¼šDOM è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            console.log('URL åƒæ•¸:', urlParams);
            console.log('åˆå§‹å°ˆæ¡ˆ:', app.currentProject);
            
            // åˆå§‹åŒ–è³‡æ–™
            initData();
            
            // ğŸ¯ ä¿®å¾©ï¼šè¨­å®šå°ˆæ¡ˆé»æ“Šäº‹ä»¶è™•ç†å™¨ï¼ˆå¤šé‡ç­–ç•¥ï¼‰
            setupProjectClickHandlers();

            // è‡ªå‹•ä¸Šå‚³è¨­å®šè®Šæ›´ç›£è½
            document.getElementById('autoUploadToggle').addEventListener('change', function() {
                const intervalGroup = document.getElementById('autoUploadIntervalGroup');
                intervalGroup.style.display = this.checked ? 'block' : 'none';
            });

            // ğŸ¯ ä¿®å¾©ï¼šè™•ç† Gist ä¸‹è¼‰
            if (urlParams.gist && app.token) {
                console.log('æª¢æ¸¬åˆ° Gist åƒæ•¸ï¼Œæº–å‚™ä¸‹è¼‰...');
                downloadGist().then(() => {
                    // ä¸‹è¼‰å®Œæˆå¾Œï¼Œæ ¹æ“š URL åƒæ•¸è¼‰å…¥æ­£ç¢ºçš„å°ˆæ¡ˆå’Œå±¤ç´š
                    if (urlParams.project) {
                        loadProject(urlParams.project, false);
                        if (urlParams.layer && urlParams.layer !== 'main') {
                            setTimeout(() => enterLayer(urlParams.layer), 100);
                        }
                    }
                });
            } else if (urlParams.gist && !app.token) {
                alert('æª¢æ¸¬åˆ°åˆ†äº«é€£çµï¼Œè«‹å…ˆè¨­å®š GitHub Token å¾Œä¸‹è¼‰è³‡æ–™');
                showGitHubModal();
            } else if (urlParams.layer && urlParams.layer !== 'main') {
                // æ²’æœ‰ Gist ä½†æœ‰å±¤ç´šåƒæ•¸ï¼Œç›´æ¥é€²å…¥å°æ‡‰å±¤ç´š
                setTimeout(() => enterLayer(urlParams.layer), 100);
            }

            // æª¢æŸ¥ GitHub Token å’Œè‡ªå‹•ä¸Šå‚³è¨­å®š
            if (app.token) {
                setSyncStatus('synced', 'å·²é€£æ¥');
                if (app.autoUploadEnabled) {
                    AutoUploadManager.start();
                }
            }

            // æ¨¡æ…‹æ¡†é»æ“Šå¤–éƒ¨é—œé–‰
            document.getElementById('githubModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeGitHubModal();
                }
            });
            
            console.log('ğŸ¯ çµ‚æ¥µç‰ˆï¼šåˆå§‹åŒ–å®Œæˆï¼Œç•¶å‰å°ˆæ¡ˆ:', app.currentProject, 'ç•¶å‰å±¤ç´š:', app.currentLayer);
            console.log('è‡ªå‹•ä¸Šå‚³ç‹€æ…‹:', app.autoUploadEnabled ? `å•Ÿç”¨ (${app.autoUploadIntervalMinutes}åˆ†é˜)` : 'åœç”¨');
        });

        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šé é¢å³å°‡é›¢é–‹æ™‚å¼·åˆ¶å„²å­˜
        window.addEventListener('beforeunload', function(e) {
            console.log('ğŸ¯ çµ‚æ¥µç‰ˆï¼šé é¢å³å°‡é›¢é–‹ï¼Œå¼·åˆ¶å„²å­˜...');
            
            // å¼·åˆ¶å„²å­˜åˆ°æ‰€æœ‰ä½ç½®
            if (app.data) {
                app.data.updatedAt = new Date().toISOString();
                
                try {
                    localStorage.setItem(StorageManager.keys.primary, JSON.stringify(app.data));
                    localStorage.setItem(StorageManager.keys.backup, JSON.stringify(app.data));
                    sessionStorage.setItem(StorageManager.keys.session, JSON.stringify(app.data));
                    console.log('âœ… é›¢é–‹å‰å„²å­˜æˆåŠŸ');
                } catch (error) {
                    console.error('âŒ é›¢é–‹å‰å„²å­˜å¤±æ•—:', error);
                }
            }
            
            // æ¸…ç†è¨ˆæ™‚å™¨
            if (app.autoSaveInterval) {
                clearInterval(app.autoSaveInterval);
            }
            if (app.autoUploadInterval) {
                clearInterval(app.autoUploadInterval);
            }
        });

        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šé é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚å„²å­˜
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                console.log('ğŸ¯ çµ‚æ¥µç‰ˆï¼šé é¢éš±è—ï¼ŒåŸ·è¡Œå„²å­˜...');
                saveToStorage(false);
            }
        });

        // ç€è¦½å™¨å‰é€²å¾Œé€€è™•ç†
        window.addEventListener('popstate', function() {
            const params = parseUrlParams();
            const project = params.project || '2.6.1';
            const layer = params.layer || 'main';
            
            console.log('ç€è¦½å™¨å°èˆª:', project, layer);
            
            if (project !== app.currentProject) {
                loadProject(project, false);
            }
            if (layer !== app.currentLayer) {
                if (layer === 'main') {
                    app.currentLayer = 'main';
                    updateBreadcrumb();
                    renderMainLayer();
                } else {
                    app.currentLayer = layer;
                    updateBreadcrumb();
                    renderSubLayer(layer);
                }
            }
        });

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveLocal();
                        break;
                    case 'l':
                        e.preventDefault();
                        loadLocal();
                        break;
                    case 'i':
                        e.preventDefault();
                        importJSONFile();
                        break;
                    case 'x':
                        e.preventDefault();
                        exportJSON();
                        break;
                    case 'u':
                        e.preventDefault();
                        uploadGist();
                        break;
                    case 'd':
                        e.preventDefault();
                        downloadGist();
                        break;
                    case 'Backspace':
                        e.preventDefault();
                        clearAH();
                        break;
                    case '1':
                        e.preventDefault();
                        setFontSize('small');
                        break;
                    case '2':
                        e.preventDefault();
                        setFontSize('medium');
                        break;
                    case '3':
                        e.preventDefault();
                        setFontSize('large');
                        break;
                    case '4':
                        e.preventDefault();
                        setFontSize('xlarge');
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                closeGitHubModal();
                if (app.currentLayer !== 'main') {
                    returnToMain();
                }
            }
        });

        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šéŒ¯èª¤è™•ç†æ©Ÿåˆ¶
        window.addEventListener('error', function(e) {
            console.error('ğŸ¯ çµ‚æ¥µç‰ˆï¼šæ•ç²å…¨åŸŸéŒ¯èª¤:', e.error);
            
            // å˜—è©¦ç·Šæ€¥å„²å­˜
            if (app.data) {
                try {
                    sessionStorage.setItem('mandala_emergency_backup', JSON.stringify(app.data));
                    console.log('âœ… ç·Šæ€¥å‚™ä»½å·²å„²å­˜åˆ° sessionStorage');
                } catch (backupError) {
                    console.error('âŒ ç·Šæ€¥å‚™ä»½å¤±æ•—:', backupError);
                }
            }
        });

        // ğŸ¯ çµ‚æ¥µç‰ˆï¼šæœªè™•ç†çš„ Promise éŒ¯èª¤
        window.addEventListener('unhandledrejection', function(e) {
            console.error('ğŸ¯ çµ‚æ¥µç‰ˆï¼šæ•ç²æœªè™•ç†çš„ Promise éŒ¯èª¤:', e.reason);
            e.preventDefault(); // é˜²æ­¢éŒ¯èª¤é˜»æ­¢ç¨‹åºé‹è¡Œ
        });

        console.log('ğŸ¯ çµ‚æ¥µç‰ˆæ›¼é™€ç¾…ç³»çµ±è¼‰å…¥å®Œæˆ - å…·å‚™è‡ªå‹•å®šæ™‚ä¸Šå‚³ + å®Œå…¨ä¿®å¾©å·¦å´é¸å–®');
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDpV5eVK1DgtyvMEXX9pp6UqLZZXBPBTUgGVpu5ccmpZfE8g59HYA0cl24vO7%2F7J8z9qKq0%2BbxzEDiEs%2FpZ24b9jxOnviiLEMG1xX%2FE4zqI3czIj5mcp5Bj8ZWtIxDZBFFqjPXdMQnlroSs32QzZnKJiGDh8ncVaZWx%2BNbuUykvDE80PfOvB%2BrW2D4coVruWzxC2hc2MoDkvi4qB7ZN3Xw9Slugf8bs6ua4CrdMDsNoCxYux5NFgkOUhTLuE1IfbO03x6eiKu8iRZJBUcXmhfaLrvHD%2FbSfD1uXKH3tkzY4bRUqe5u4hDbNrYbiOr1dHdjKZgtEsY%2FGJqg9ANP8hbWQW94%2FQvzPI5e518WrcU0JnGTxwa6OlFmols%2FmvZz3%2FgFAkH9kYEPw%2BBk43mmatXd%2B%2BLam1UjvTU4IplCMfP9xfCBmf6fWizO06eV%2Fxq2YD4pXyPBmALUEnUvN0ZkFOuTHxQNNHMrSmQNQv3%2B%2BDPLezWVNZnHA1MERexvZnjYpkRdw%3D%3D";
        window.__genspark_locale = "zh-TW";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDpV5eVK1DgtyvMEXX9pp6UqLZZXBPBTUgGVpu5ccmpZfE8g59HYA0cl24vO7/7J8z9qKq0+bxzEDiEs/pZ24b9jxOnviiLEMG1xX/E4zqI3czIj5mcp5Bj8ZWtIxDZBFFqjPXdMQnlroSs32QzZnKJiGDh8ncVaZWx+NbuUykvDE80PfOvB+rW2D4coVruWzxC2hc2MoDkvi4qB7ZN3Xw9Slugf8bs6ua4CrdMDsNoCxYux5NFgkOUhTLuE1IfbO03x6eiKu8iRZJBUcXmhfaLrvHD/bSfD1uXKH3tkzY4bRUqe5u4hDbNrYbiOr1dHdjKZgtEsY/GJqg9ANP8hbWQW94/QvzPI5e518WrcU0JnGTxwa6OlFmols/mvZz3/gFAkH9kYEPw+Bk43mmatXd++Lam1UjvTU4IplCMfP9xfCBmf6fWizO06eV/xq2YD4pXyPBmALUEnUvN0ZkFOuTHxQNNHMrSmQNQv3++DPLezWVNZnHA1MERexvZnjYpkRdw==";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    