<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›¼é™€ç¾…å°ˆæ¡ˆç®¡ç†ç³»çµ± - å›ºå®šç¶²å€ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Microsoft JhengHei', 'PingFang SC', 'Apple LiGothic Medium', sans-serif; }
        .mandala-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            aspect-ratio: 1;
            max-width: 480px;
            width: 100%;
        }
        .grid-cell { 
            background: #f8fafc; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            padding: 8px; 
            display: flex; 
            flex-direction: column;
            min-height: 100px;
            position: relative;
        }
        .grid-cell:hover { background: #f1f5f9; }
        .cell-label { 
            font-size: 12px; 
            font-weight: 700; 
            margin-bottom: 4px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            color: white;
            flex-shrink: 0;
        }
        .cell-content { 
            flex: 1; 
            resize: none; 
            border: none; 
            outline: none; 
            background: transparent; 
            font-size: 12px; 
            line-height: 1.4;
            width: 100%;
        }
        .center-cell { background: #e2e8f0; border-color: #94a3b8; }
        .center-label { background: #64748b; }
        .ring-cell { background: #f1f5f9; }
        .ring-label { background: #3b82f6; }
        .detail-cell { background: #f8fafc; }
        .detail-label { background: #6b7280; }
        
        /* ç« ç¯€é¡è‰² */
        .chapter-26 { --chapter-color: #3b82f6; }
        .chapter-27 { --chapter-color: #10b981; }
        .chapter-28 { --chapter-color: #f59e0b; }
        .chapter-29 { --chapter-color: #8b5cf6; }
        
        .sidebar { 
            width: 280px; 
            height: 100vh; 
            overflow-y: auto; 
            transition: margin-left 0.3s ease;
        }
        .sidebar.hidden { margin-left: -280px; }
        .main-content { transition: margin-left 0.3s ease; }
        .main-content.expanded { margin-left: 0; }
        
        .project-item { 
            padding: 8px 12px; 
            margin: 2px 0; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .project-item:hover { background: #f1f5f9; }
        .project-item.active { background: #3b82f6; color: white; }
        
        .sync-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }
        .sync-status.synced { background: #10b981; }
        .sync-status.syncing { background: #f59e0b; animation: pulse 2s infinite; }
        .sync-status.error { background: #ef4444; }
        .sync-status.offline { background: #6b7280; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @media (max-width: 1024px) {
            .sidebar { width: 240px; }
            .sidebar.hidden { margin-left: -240px; }
            .mandala-grid { max-width: 400px; }
            .grid-cell { min-height: 80px; }
        }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; z-index: 50; }
            .sidebar.hidden { margin-left: -100%; }
            .main-content { margin-left: 0 !important; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- å›ºå®šç¶²å€éƒ¨ç½²èªªæ˜ Modal -->
    <div id="deployModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">ğŸ”— å›ºå®šç¶²å€éƒ¨ç½²æ–¹æ¡ˆ</h3>
                <button onclick="closeDeployModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4 text-sm">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-bold text-blue-800 mb-2">ğŸš€ æ¨è–¦æ–¹æ¡ˆï¼šAI Driveéƒ¨ç½²</h4>
                    <p>é»æ“Šä¸‹æ–¹ã€Œéƒ¨ç½²åˆ°AI Driveã€æŒ‰éˆ•ï¼Œç²å¾—æ°¸ä¹…å›ºå®šç¶²å€</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <h4 class="font-bold text-green-800 mb-2">ğŸ“‚ GitHub Pageséƒ¨ç½²</h4>
                    <ol class="list-decimal ml-4 space-y-1">
                        <li>ä¸‹è¼‰æ­¤HTMLæª”æ¡ˆ</li>
                        <li>ä¸Šå‚³åˆ°GitHub Repository</li>
                        <li>å•Ÿç”¨GitHub Pages</li>
                        <li>ç²å¾—å¦‚ï¼šyourname.github.io/mandala çš„å›ºå®šç¶²å€</li>
                    </ol>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg">
                    <h4 class="font-bold text-yellow-800 mb-2">ğŸ  è‡ªå»ºä¼ºæœå™¨éƒ¨ç½²</h4>
                    <p>ä¸‹è¼‰HTMLæª”æ¡ˆï¼Œä¸Šå‚³åˆ°æ‚¨çš„è™›æ“¬ä¸»æ©Ÿæˆ–ä¼ºæœå™¨</p>
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button onclick="downloadHTML()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    <i class="fas fa-download mr-2"></i>ä¸‹è¼‰HTMLæª”æ¡ˆ
                </button>
                <button onclick="closeDeployModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar bg-white shadow-lg border-r border-gray-200">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-bold text-gray-800">æ›¼é™€ç¾…å°ˆæ¡ˆç®¡ç†</h2>
                    <button onclick="toggleSidebar()" class="lg:hidden">
                        <i class="fas fa-times text-gray-500"></i>
                    </button>
                </div>
                
                <!-- GitHub è¨­å®šç‹€æ…‹ -->
                <div id="githubStatus" class="text-xs text-gray-600 mb-2">
                    <i class="fas fa-github mr-1"></i>
                    <span id="githubStatusText">æœªé€£æ¥GitHub</span>
                    <span id="githubSyncStatus" class="sync-status offline"></span>
                </div>
                
                <!-- å¿«é€Ÿæœå°‹ -->
                <div class="relative">
                    <input type="text" id="projectSearch" placeholder="æœå°‹å°ˆæ¡ˆ (å¦‚: 2.6.1 æˆ– ç›®æ¨™)" 
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                </div>
            </div>
            
            <!-- å°ˆæ¡ˆåˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto p-2">
                <div id="projectList">
                    <!-- 2.6 ç³»åˆ— -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between px-2 py-1 text-sm font-semibold text-blue-800 bg-blue-50 rounded">
                            <span><i class="fas fa-folder mr-2"></i>2.6 ç³»åˆ—</span>
                            <span class="text-xs">7é …</span>
                        </div>
                        <div class="ml-4 mt-1">
                            <div class="project-item chapter-26" data-project="2.6.1">
                                <i class="fas fa-bullseye mr-2"></i>2.6.1 ç›®æ¨™
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-26" data-project="2.6.2">
                                <i class="fas fa-exclamation-triangle mr-2"></i>2.6.2 é˜»ç¤™
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-26" data-project="2.6.3">
                                <i class="fas fa-dumbbell mr-2"></i>2.6.3 åŠªåŠ›
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-26" data-project="2.6.4">
                                <i class="fas fa-check-circle mr-2"></i>2.6.4 çµæœ
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-26" data-project="2.6.5">
                                <i class="fas fa-bolt mr-2"></i>2.6.5 æ„å¤–
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-26" data-project="2.6.6">
                                <i class="fas fa-exchange-alt mr-2"></i>2.6.6 è½‰å½
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-26" data-project="2.6.7">
                                <i class="fas fa-flag-checkered mr-2"></i>2.6.7 çµå±€
                                <span class="sync-status offline"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.7 ç³»åˆ— -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between px-2 py-1 text-sm font-semibold text-green-800 bg-green-50 rounded">
                            <span><i class="fas fa-folder mr-2"></i>2.7 ç³»åˆ—</span>
                            <span class="text-xs">7é …</span>
                        </div>
                        <div class="ml-4 mt-1">
                            <div class="project-item chapter-27" data-project="2.7.1">
                                <i class="fas fa-bullseye mr-2"></i>2.7.1 ç›®æ¨™
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-27" data-project="2.7.2">
                                <i class="fas fa-exclamation-triangle mr-2"></i>2.7.2 é˜»ç¤™
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-27" data-project="2.7.3">
                                <i class="fas fa-dumbbell mr-2"></i>2.7.3 åŠªåŠ›
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-27" data-project="2.7.4">
                                <i class="fas fa-check-circle mr-2"></i>2.7.4 çµæœ
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-27" data-project="2.7.5">
                                <i class="fas fa-bolt mr-2"></i>2.7.5 æ„å¤–
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-27" data-project="2.7.6">
                                <i class="fas fa-exchange-alt mr-2"></i>2.7.6 è½‰å½
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-27" data-project="2.7.7">
                                <i class="fas fa-flag-checkered mr-2"></i>2.7.7 çµå±€
                                <span class="sync-status offline"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.8 ç³»åˆ— -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between px-2 py-1 text-sm font-semibold text-yellow-800 bg-yellow-50 rounded">
                            <span><i class="fas fa-folder mr-2"></i>2.8 ç³»åˆ—</span>
                            <span class="text-xs">7é …</span>
                        </div>
                        <div class="ml-4 mt-1">
                            <div class="project-item chapter-28" data-project="2.8.1">
                                <i class="fas fa-bullseye mr-2"></i>2.8.1 ç›®æ¨™
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-28" data-project="2.8.2">
                                <i class="fas fa-exclamation-triangle mr-2"></i>2.8.2 é˜»ç¤™
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-28" data-project="2.8.3">
                                <i class="fas fa-dumbbell mr-2"></i>2.8.3 åŠªåŠ›
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-28" data-project="2.8.4">
                                <i class="fas fa-check-circle mr-2"></i>2.8.4 çµæœ
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-28" data-project="2.8.5">
                                <i class="fas fa-bolt mr-2"></i>2.8.5 æ„å¤–
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-28" data-project="2.8.6">
                                <i class="fas fa-exchange-alt mr-2"></i>2.8.6 è½‰å½
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-28" data-project="2.8.7">
                                <i class="fas fa-flag-checkered mr-2"></i>2.8.7 çµå±€
                                <span class="sync-status offline"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.9 ç³»åˆ— -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between px-2 py-1 text-sm font-semibold text-purple-800 bg-purple-50 rounded">
                            <span><i class="fas fa-folder mr-2"></i>2.9 ç³»åˆ—</span>
                            <span class="text-xs">7é …</span>
                        </div>
                        <div class="ml-4 mt-1">
                            <div class="project-item chapter-29" data-project="2.9.1">
                                <i class="fas fa-bullseye mr-2"></i>2.9.1 ç›®æ¨™
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-29" data-project="2.9.2">
                                <i class="fas fa-exclamation-triangle mr-2"></i>2.9.2 é˜»ç¤™
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-29" data-project="2.9.3">
                                <i class="fas fa-dumbbell mr-2"></i>2.9.3 åŠªåŠ›
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-29" data-project="2.9.4">
                                <i class="fas fa-check-circle mr-2"></i>2.9.4 çµæœ
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-29" data-project="2.9.5">
                                <i class="fas fa-bolt mr-2"></i>2.9.5 æ„å¤–
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-29" data-project="2.9.6">
                                <i class="fas fa-exchange-alt mr-2"></i>2.9.6 è½‰å½
                                <span class="sync-status offline"></span>
                            </div>
                            <div class="project-item chapter-29" data-project="2.9.7">
                                <i class="fas fa-flag-checkered mr-2"></i>2.9.7 çµå±€
                                <span class="sync-status offline"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- GitHub è¨­å®šæŒ‰éˆ• -->
            <div class="p-4 border-t border-gray-200">
                <button onclick="showGitHubSetup()" class="w-full bg-gray-800 text-white py-2 px-4 rounded-md text-sm hover:bg-gray-700 transition-colors">
                    <i class="fab fa-github mr-2"></i>GitHub é›²ç«¯è¨­å®š
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div id="mainContent" class="main-content flex-1 flex flex-col ml-0 lg:ml-280">
            <!-- Top Bar -->
            <div class="bg-white shadow-sm border-b border-gray-200 px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()" class="lg:hidden">
                            <i class="fas fa-bars text-gray-600"></i>
                        </button>
                        
                        <!-- å°ˆæ¡ˆé¸æ“‡å™¨ -->
                        <select id="projectSelector" class="text-lg font-semibold text-gray-800 border-none bg-transparent focus:outline-none cursor-pointer">
                            <option value="">é¸æ“‡å°ˆæ¡ˆ...</option>
                        </select>
                        
                        <!-- éºµåŒ…å±‘ -->
                        <div id="breadcrumb" class="text-sm text-gray-500 hidden md:block"></div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <!-- åŒæ­¥ç‹€æ…‹æŒ‡ç¤º -->
                        <div id="syncIndicator" class="flex items-center text-sm text-gray-600">
                            <span id="syncStatusIcon" class="sync-status offline mr-2"></span>
                            <span id="syncStatusText">é›¢ç·š</span>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="flex gap-2">
                            <button onclick="saveProject()" class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 transition-colors">
                                <i class="fas fa-save mr-1"></i>å„²å­˜
                            </button>
                            <button onclick="loadProject()" class="bg-green-500 text-white px-3 py-1.5 rounded text-sm hover:bg-green-600 transition-colors">
                                <i class="fas fa-undo mr-1"></i>å›è¦†
                            </button>
                            <button onclick="exportCurrentOPML()" class="bg-purple-500 text-white px-3 py-1.5 rounded text-sm hover:bg-purple-600 transition-colors">
                                <i class="fas fa-download mr-1"></i>åŒ¯å‡º
                            </button>
                            <button onclick="importOPML()" class="bg-yellow-500 text-white px-3 py-1.5 rounded text-sm hover:bg-yellow-600 transition-colors">
                                <i class="fas fa-upload mr-1"></i>åŒ¯å…¥
                            </button>
                            <button onclick="showDeployModal()" class="bg-red-500 text-white px-3 py-1.5 rounded text-sm hover:bg-red-600 transition-colors">
                                <i class="fas fa-link mr-1"></i>å›ºå®šç¶²å€
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å°ˆæ¡ˆå…§å®¹å€ -->
            <div class="flex-1 p-6 overflow-auto">
                <div id="welcomeScreen" class="text-center py-20">
                    <i class="fas fa-th text-6xl text-gray-300 mb-6"></i>
                    <h2 class="text-2xl font-bold text-gray-600 mb-4">æ­¡è¿ä½¿ç”¨æ›¼é™€ç¾…å°ˆæ¡ˆç®¡ç†ç³»çµ±</h2>
                    <p class="text-gray-500 mb-6">è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹å°ˆæ¡ˆé–‹å§‹ç·¨è¼¯</p>
                    <div class="space-y-2 text-sm text-gray-400">
                        <p>ğŸ’¡ æç¤ºï¼šè¨­å®šGitHub Tokenä»¥å•Ÿç”¨é›²ç«¯åŒæ­¥</p>
                        <p>ğŸ”— é»æ“Šå³ä¸Šè§’ã€Œå›ºå®šç¶²å€ã€äº†è§£éƒ¨ç½²æ–¹æ¡ˆ</p>
                    </div>
                </div>
                
                <div id="mandalaEditor" class="hidden">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 id="projectTitle" class="text-2xl font-bold text-gray-800"></h1>
                            <p id="projectSubtitle" class="text-gray-600"></p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="clearCurrentLevel()" class="bg-orange-500 text-white px-3 py-1.5 rounded text-sm hover:bg-orange-600">
                                <i class="fas fa-eraser mr-1"></i>æ¸…é™¤ç•¶å‰å±¤
                            </button>
                            <button onclick="clearEntireMandala()" class="bg-red-500 text-white px-3 py-1.5 rounded text-sm hover:bg-red-600">
                                <i class="fas fa-trash mr-1"></i>æ¸…é™¤æ•´å€‹æ›¼é™€ç¾…
                            </button>
                        </div>
                    </div>
                    
                    <!-- è¿”å›æŒ‰éˆ• -->
                    <button id="backButton" onclick="goBackToLevel1()" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded text-sm hover:bg-gray-600 hidden">
                        <i class="fas fa-arrow-left mr-2"></i>è¿”å›ç¬¬ä¸€å±¤
                    </button>
                    
                    <!-- ä¹å®®æ ¼ -->
                    <div class="flex justify-center">
                        <div id="mandalaGrid" class="mandala-grid">
                            <!-- ä¹å®®æ ¼å…§å®¹å°‡é€šé JavaScript ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- å°èˆªæç¤º -->
                    <div id="navigationInfo" class="mt-6 p-4 bg-blue-50 rounded-lg text-center text-sm text-blue-800">
                        é»æ“Š Aã€Bã€Cã€Dã€Eã€Fã€Gã€H é€²å…¥ç¬¬äºŒå±¤ä¹å®®æ ¼ç·¨è¼¯ç´°ç¯€å…§å®¹
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GitHub è¨­å®š Modal -->
    <div id="githubModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">GitHub é›²ç«¯è¨­å®š</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">éœ€è¦ 'gist' æ¬Šé™</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="connectGitHub()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex-1">
                        é€£æ¥ GitHub
                    </button>
                    <button onclick="closeGitHubModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æª”æ¡ˆåŒ¯å…¥ -->
    <input type="file" id="fileInput" accept=".opml,.xml" style="display: none;" onchange="handleFileImport(event)">

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentProject = null;
        let currentLevel = 1; // 1=ç¬¬ä¸€å±¤, 2=ç¬¬äºŒå±¤
        let currentSection = null; // A-H
        let githubToken = localStorage.getItem('github_token') || '';
        let projectData = {};
        let sidebarVisible = window.innerWidth >= 1024;
        
        // å°ˆæ¡ˆé…ç½®
        const PROJECT_CONFIG = {
            '2.6.1': { name: 'ç›®æ¨™', chapter: '2.6', color: 'blue' },
            '2.6.2': { name: 'é˜»ç¤™', chapter: '2.6', color: 'blue' },
            '2.6.3': { name: 'åŠªåŠ›', chapter: '2.6', color: 'blue' },
            '2.6.4': { name: 'çµæœ', chapter: '2.6', color: 'blue' },
            '2.6.5': { name: 'æ„å¤–', chapter: '2.6', color: 'blue' },
            '2.6.6': { name: 'è½‰å½', chapter: '2.6', color: 'blue' },
            '2.6.7': { name: 'çµå±€', chapter: '2.6', color: 'blue' },
            '2.7.1': { name: 'ç›®æ¨™', chapter: '2.7', color: 'green' },
            '2.7.2': { name: 'é˜»ç¤™', chapter: '2.7', color: 'green' },
            '2.7.3': { name: 'åŠªåŠ›', chapter: '2.7', color: 'green' },
            '2.7.4': { name: 'çµæœ', chapter: '2.7', color: 'green' },
            '2.7.5': { name: 'æ„å¤–', chapter: '2.7', color: 'green' },
            '2.7.6': { name: 'è½‰å½', chapter: '2.7', color: 'green' },
            '2.7.7': { name: 'çµå±€', chapter: '2.7', color: 'green' },
            '2.8.1': { name: 'ç›®æ¨™', chapter: '2.8', color: 'yellow' },
            '2.8.2': { name: 'é˜»ç¤™', chapter: '2.8', color: 'yellow' },
            '2.8.3': { name: 'åŠªåŠ›', chapter: '2.8', color: 'yellow' },
            '2.8.4': { name: 'çµæœ', chapter: '2.8', color: 'yellow' },
            '2.8.5': { name: 'æ„å¤–', chapter: '2.8', color: 'yellow' },
            '2.8.6': { name: 'è½‰å½', chapter: '2.8', color: 'yellow' },
            '2.8.7': { name: 'çµå±€', chapter: '2.8', color: 'yellow' },
            '2.9.1': { name: 'ç›®æ¨™', chapter: '2.9', color: 'purple' },
            '2.9.2': { name: 'é˜»ç¤™', chapter: '2.9', color: 'purple' },
            '2.9.3': { name: 'åŠªåŠ›', chapter: '2.9', color: 'purple' },
            '2.9.4': { name: 'çµæœ', chapter: '2.9', color: 'purple' },
            '2.9.5': { name: 'æ„å¤–', chapter: '2.9', color: 'purple' },
            '2.9.6': { name: 'è½‰å½', chapter: '2.9', color: 'purple' },
            '2.9.7': { name: 'çµå±€', chapter: '2.9', color: 'purple' }
        };
        
        // ä¹å®®æ ¼å¸ƒå±€é †åº
        const LEVEL1_ORDER = ['F', 'C', 'G', 'B', 'CENTER', 'D', 'E', 'A', 'H'];
        const LEVEL2_ORDER = ['6', '3', '7', '2', 'CENTER', '4', '5', '1', '8'];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            updateSidebarVisibility();
            checkGitHubConnection();
            loadProjectsFromLocalStorage();
            setupRouting();
            setupProjectSelector();
            setupSearch();
        });
        
        // è·¯ç”±ç³»çµ±
        function setupRouting() {
            const hash = window.location.hash;
            if (hash.startsWith('#/mandala/')) {
                const projectId = hash.replace('#/mandala/', '');
                if (PROJECT_CONFIG[projectId]) {
                    selectProject(projectId);
                }
            }
            
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash;
                if (hash.startsWith('#/mandala/')) {
                    const projectId = hash.replace('#/mandala/', '');
                    if (PROJECT_CONFIG[projectId]) {
                        selectProject(projectId);
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–æ‡‰ç”¨
        function initializeApp() {
            // åˆå§‹åŒ–å°ˆæ¡ˆæ•¸æ“šçµæ§‹
            Object.keys(PROJECT_CONFIG).forEach(projectId => {
                if (!projectData[projectId]) {
                    projectData[projectId] = createEmptyMandala();
                }
            });
            
            // è¨­ç½®é …ç›®é»æ“Šäº‹ä»¶
            document.querySelectorAll('.project-item').forEach(item => {
                item.addEventListener('click', () => {
                    const projectId = item.getAttribute('data-project');
                    selectProject(projectId);
                });
            });
            
            // éŸ¿æ‡‰å¼è™•ç†
            window.addEventListener('resize', updateSidebarVisibility);
        }
        
        // å‰µå»ºç©ºçš„æ›¼é™€ç¾…æ•¸æ“šçµæ§‹
        function createEmptyMandala() {
            const mandala = {
                center: { content: '' },
                sections: {}
            };
            
            ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'].forEach(letter => {
                mandala.sections[letter] = {
                    center: { content: '' },
                    details: {}
                };
                
                ['1', '2', '3', '4', '5', '6', '7', '8'].forEach(num => {
                    mandala.sections[letter].details[num] = { content: '' };
                });
            });
            
            return mandala;
        }
        
        // é¸æ“‡å°ˆæ¡ˆ
        function selectProject(projectId) {
            if (!PROJECT_CONFIG[projectId]) return;
            
            currentProject = projectId;
            currentLevel = 1;
            currentSection = null;
            
            // æ›´æ–°URL
            window.location.hash = `/mandala/${projectId}`;
            
            // æ›´æ–°UI
            updateActiveProject();
            showMandalaEditor();
            renderMandala();
            updateBreadcrumb();
            
            // å¾é›²ç«¯è¼‰å…¥è³‡æ–™
            loadProjectFromCloud(projectId);
        }
        
        // æ›´æ–°å°ˆæ¡ˆé¸æ“‡å™¨
        function setupProjectSelector() {
            const selector = document.getElementById('projectSelector');
            selector.innerHTML = '<option value="">é¸æ“‡å°ˆæ¡ˆ...</option>';
            
            Object.keys(PROJECT_CONFIG).forEach(projectId => {
                const config = PROJECT_CONFIG[projectId];
                const option = document.createElement('option');
                option.value = projectId;
                option.textContent = `${projectId} ${config.name}`;
                selector.appendChild(option);
            });
            
            selector.addEventListener('change', (e) => {
                if (e.target.value) {
                    selectProject(e.target.value);
                }
            });
        }
        
        // æœå°‹åŠŸèƒ½
        function setupSearch() {
            const searchInput = document.getElementById('projectSearch');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('.project-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const parent = item.closest('.mb-4');
                    if (text.includes(query)) {
                        item.style.display = 'block';
                        parent.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // å¦‚æœæ²’æœ‰æœå°‹å…§å®¹ï¼Œé¡¯ç¤ºæ‰€æœ‰é …ç›®
                if (!query) {
                    document.querySelectorAll('.project-item').forEach(item => {
                        item.style.display = 'block';
                    });
                    document.querySelectorAll('.mb-4').forEach(section => {
                        section.style.display = 'block';
                    });
                }
            });
        }
        
        // æ›´æ–°æ´»èºå°ˆæ¡ˆ
        function updateActiveProject() {
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (currentProject) {
                const activeItem = document.querySelector(`[data-project="${currentProject}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
                
                // æ›´æ–°å°ˆæ¡ˆé¸æ“‡å™¨
                document.getElementById('projectSelector').value = currentProject;
            }
        }
        
        // é¡¯ç¤ºæ›¼é™€ç¾…ç·¨è¼¯å™¨
        function showMandalaEditor() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('mandalaEditor').classList.remove('hidden');
            
            const config = PROJECT_CONFIG[currentProject];
            document.getElementById('projectTitle').textContent = `${currentProject} ${config.name}`;
            document.getElementById('projectSubtitle').textContent = `${config.chapter} ç³»åˆ—`;
        }
        
        // æ¸²æŸ“æ›¼é™€ç¾…
        function renderMandala() {
            const grid = document.getElementById('mandalaGrid');
            grid.innerHTML = '';
            
            if (currentLevel === 1) {
                renderLevel1();
            } else {
                renderLevel2();
            }
        }
        
        // æ¸²æŸ“ç¬¬ä¸€å±¤
        function renderLevel1() {
            const grid = document.getElementById('mandalaGrid');
            document.getElementById('backButton').classList.add('hidden');
            document.getElementById('navigationInfo').textContent = 'é»æ“Š Aã€Bã€Cã€Dã€Eã€Fã€Gã€H é€²å…¥ç¬¬äºŒå±¤ä¹å®®æ ¼ç·¨è¼¯ç´°ç¯€å…§å®¹';
            
            LEVEL1_ORDER.forEach(pos => {
                const cell = document.createElement('div');
                
                if (pos === 'CENTER') {
                    cell.className = 'grid-cell center-cell';
                    const content = projectData[currentProject]?.center?.content || '';
                    cell.innerHTML = `
                        <div class="cell-label center-label">ä¸­å¿ƒ</div>
                        <textarea class="cell-content" placeholder="ä¸»ä¸­å¿ƒå…§å®¹..." 
                                  onchange="updateContent('center', '', this.value)">${content}</textarea>
                    `;
                } else {
                    cell.className = 'grid-cell ring-cell cursor-pointer';
                    const sectionData = projectData[currentProject]?.sections?.[pos];
                    const content = sectionData?.center?.content || '';
                    cell.innerHTML = `
                        <div class="cell-label ring-label">${pos}</div>
                        <textarea class="cell-content" placeholder="${pos} å€åŸŸä¸­å¿ƒ..." 
                                  onchange="updateContent('section', '${pos}', this.value)">${content}</textarea>
                    `;
                    
                    cell.addEventListener('click', (e) => {
                        if (e.target.classList.contains('cell-label')) {
                            enterLevel2(pos);
                        }
                    });
                }
                
                grid.appendChild(cell);
            });
        }
        
        // æ¸²æŸ“ç¬¬äºŒå±¤
        function renderLevel2() {
            const grid = document.getElementById('mandalaGrid');
            document.getElementById('backButton').classList.remove('hidden');
            document.getElementById('navigationInfo').textContent = `æ­£åœ¨ç·¨è¼¯ ${currentSection} å€åŸŸçš„è©³ç´°å…§å®¹ï¼Œä¸­å¤®ç‚ºè©²å€åŸŸçš„ä¸­å¿ƒä¸»é¡Œ`;
            
            LEVEL2_ORDER.forEach(pos => {
                const cell = document.createElement('div');
                
                if (pos === 'CENTER') {
                    cell.className = 'grid-cell ring-cell';
                    const content = projectData[currentProject]?.sections?.[currentSection]?.center?.content || '';
                    cell.innerHTML = `
                        <div class="cell-label ring-label">${currentSection}</div>
                        <textarea class="cell-content" placeholder="${currentSection} å€åŸŸä¸­å¿ƒ..." 
                                  onchange="updateContent('section', '${currentSection}', this.value)">${content}</textarea>
                    `;
                } else {
                    cell.className = 'grid-cell detail-cell';
                    const detailData = projectData[currentProject]?.sections?.[currentSection]?.details?.[pos];
                    const content = detailData?.content || '';
                    cell.innerHTML = `
                        <div class="cell-label detail-label">${pos}</div>
                        <textarea class="cell-content" placeholder="è©³ç´°å…§å®¹..." 
                                  onchange="updateContent('detail', '${currentSection}.${pos}', this.value)">${content}</textarea>
                    `;
                }
                
                grid.appendChild(cell);
            });
        }
        
        // é€²å…¥ç¬¬äºŒå±¤
        function enterLevel2(section) {
            currentLevel = 2;
            currentSection = section;
            renderMandala();
            updateBreadcrumb();
        }
        
        // è¿”å›ç¬¬ä¸€å±¤
        function goBackToLevel1() {
            currentLevel = 1;
            currentSection = null;
            renderMandala();
            updateBreadcrumb();
        }
        
        // æ›´æ–°å…§å®¹
        function updateContent(type, key, value) {
            if (!currentProject || !projectData[currentProject]) return;
            
            if (type === 'center') {
                projectData[currentProject].center.content = value;
            } else if (type === 'section') {
                if (!projectData[currentProject].sections[key]) {
                    projectData[currentProject].sections[key] = { center: { content: '' }, details: {} };
                }
                projectData[currentProject].sections[key].center.content = value;
            } else if (type === 'detail') {
                const [section, detail] = key.split('.');
                if (!projectData[currentProject].sections[section].details[detail]) {
                    projectData[currentProject].sections[section].details[detail] = { content: '' };
                }
                projectData[currentProject].sections[section].details[detail].content = value;
            }
            
            // æ¨™è¨˜ç‚ºéœ€è¦åŒæ­¥
            markProjectForSync(currentProject);
            
            // è‡ªå‹•å„²å­˜åˆ°æœ¬åœ°
            saveToLocalStorage();
        }
        
        // æ›´æ–°éºµåŒ…å±‘
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            if (currentProject) {
                const config = PROJECT_CONFIG[currentProject];
                let text = `${config.chapter} ç³»åˆ— > ${currentProject} ${config.name}`;
                if (currentLevel === 2) {
                    text += ` > ${currentSection} å€åŸŸ`;
                }
                breadcrumb.textContent = text;
            }
        }
        
        // Sidebar åˆ‡æ›
        function toggleSidebar() {
            sidebarVisible = !sidebarVisible;
            updateSidebarVisibility();
        }
        
        function updateSidebarVisibility() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (window.innerWidth < 1024) {
                // ç§»å‹•è¨­å‚™
                if (sidebarVisible) {
                    sidebar.classList.remove('hidden');
                } else {
                    sidebar.classList.add('hidden');
                }
                mainContent.classList.add('expanded');
            } else {
                // æ¡Œé¢è¨­å‚™
                if (sidebarVisible) {
                    sidebar.classList.remove('hidden');
                    mainContent.classList.remove('expanded');
                } else {
                    sidebar.classList.add('hidden');
                    mainContent.classList.add('expanded');
                }
            }
        }
        
        // GitHub åŠŸèƒ½
        function showGitHubSetup() {
            document.getElementById('githubModal').classList.remove('hidden');
            document.getElementById('githubToken').value = githubToken;
        }
        
        function closeGitHubModal() {
            document.getElementById('githubModal').classList.add('hidden');
        }
        
        function connectGitHub() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                alert('è«‹è¼¸å…¥GitHub Personal Access Token');
                return;
            }
            
            githubToken = token;
            localStorage.setItem('github_token', token);
            
            // æ¸¬è©¦é€£æ¥
            testGitHubConnection().then(success => {
                if (success) {
                    updateGitHubStatus(true);
                    closeGitHubModal();
                    alert('GitHubé€£æ¥æˆåŠŸï¼');
                } else {
                    alert('GitHubé€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥Tokenæ˜¯å¦æ­£ç¢º');
                }
            });
        }
        
        async function testGitHubConnection() {
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }
        
        function checkGitHubConnection() {
            if (githubToken) {
                testGitHubConnection().then(success => {
                    updateGitHubStatus(success);
                });
            }
        }
        
        function updateGitHubStatus(connected) {
            const statusText = document.getElementById('githubStatusText');
            const statusIcon = document.getElementById('githubSyncStatus');
            
            if (connected) {
                statusText.textContent = 'å·²é€£æ¥GitHub';
                statusIcon.className = 'sync-status synced';
            } else {
                statusText.textContent = 'æœªé€£æ¥GitHub';
                statusIcon.className = 'sync-status offline';
            }
        }
        
        // æ¨™è¨˜å°ˆæ¡ˆéœ€è¦åŒæ­¥
        function markProjectForSync(projectId) {
            const projectItem = document.querySelector(`[data-project="${projectId}"] .sync-status`);
            if (projectItem) {
                projectItem.className = 'sync-status syncing';
            }
        }
        
        // å„²å­˜å°ˆæ¡ˆ
        async function saveProject() {
            if (!currentProject) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å°ˆæ¡ˆ');
                return;
            }
            
            updateSyncStatus('syncing', 'åŒæ­¥ä¸­...');
            
            try {
                // ä¿å­˜åˆ°æœ¬åœ°
                saveToLocalStorage();
                
                // å¦‚æœæœ‰GitHub Tokenï¼ŒåŒæ­¥åˆ°é›²ç«¯
                if (githubToken) {
                    await saveProjectToCloud(currentProject);
                    updateSyncStatus('synced', 'å·²åŒæ­¥');
                    updateProjectSyncStatus(currentProject, 'synced');
                } else {
                    updateSyncStatus('offline', 'åƒ…æœ¬æ©Ÿå„²å­˜');
                }
                
                alert('å°ˆæ¡ˆå·²å„²å­˜');
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                updateSyncStatus('error', 'åŒæ­¥å¤±æ•—');
                alert('å„²å­˜å¤±æ•—: ' + error.message);
            }
        }
        
        // è¼‰å…¥å°ˆæ¡ˆ
        async function loadProject() {
            if (!currentProject) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å°ˆæ¡ˆ');
                return;
            }
            
            try {
                if (githubToken) {
                    // å¾é›²ç«¯è¼‰å…¥
                    await loadProjectFromCloud(currentProject);
                    renderMandala();
                    alert('å·²å¾é›²ç«¯è¼‰å…¥æœ€æ–°è³‡æ–™');
                } else {
                    // å¾æœ¬åœ°è¼‰å…¥
                    loadProjectsFromLocalStorage();
                    renderMandala();
                    alert('å·²å¾æœ¬æ©Ÿè¼‰å…¥è³‡æ–™');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                alert('è¼‰å…¥å¤±æ•—: ' + error.message);
            }
        }
        
        // é›²ç«¯å„²å­˜
        async function saveProjectToCloud(projectId) {
            const gistData = projectDataToOPML(projectId);
            const gistId = localStorage.getItem(`gist_${projectId}`);
            
            const config = PROJECT_CONFIG[projectId];
            const fileName = `mandala_${projectId}_${config.name}.opml`;
            
            const gistPayload = {
                description: `æ›¼é™€ç¾…å°ˆæ¡ˆ: ${projectId} ${config.name}`,
                files: {
                    [fileName]: {
                        content: gistData
                    }
                }
            };
            
            let url = 'https://api.github.com/gists';
            let method = 'POST';
            
            if (gistId) {
                url = `https://api.github.com/gists/${gistId}`;
                method = 'PATCH';
            }
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gistPayload)
            });
            
            if (!response.ok) {
                throw new Error(`GitHub API error: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!gistId) {
                localStorage.setItem(`gist_${projectId}`, result.id);
            }
        }
        
        // å¾é›²ç«¯è¼‰å…¥
        async function loadProjectFromCloud(projectId) {
            const gistId = localStorage.getItem(`gist_${projectId}`);
            if (!gistId) return;
            
            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) return;
                
                const gist = await response.json();
                const fileName = Object.keys(gist.files)[0];
                const content = gist.files[fileName].content;
                
                // è§£æOPMLä¸¦æ›´æ–°å°ˆæ¡ˆæ•¸æ“š
                parseOPMLToProject(content, projectId);
                updateProjectSyncStatus(projectId, 'synced');
            } catch (error) {
                console.error('å¾é›²ç«¯è¼‰å…¥å¤±æ•—:', error);
            }
        }
        
        // æ›´æ–°åŒæ­¥ç‹€æ…‹
        function updateSyncStatus(status, text) {
            const statusIcon = document.getElementById('syncStatusIcon');
            const statusText = document.getElementById('syncStatusText');
            
            statusIcon.className = `sync-status ${status}`;
            statusText.textContent = text;
        }
        
        // æ›´æ–°å°ˆæ¡ˆåŒæ­¥ç‹€æ…‹
        function updateProjectSyncStatus(projectId, status) {
            const projectItem = document.querySelector(`[data-project="${projectId}"] .sync-status`);
            if (projectItem) {
                projectItem.className = `sync-status ${status}`;
            }
        }
        
        // æœ¬æ©Ÿå„²å­˜
        function saveToLocalStorage() {
            localStorage.setItem('mandala_projects', JSON.stringify(projectData));
            localStorage.setItem('mandala_last_updated', new Date().toISOString());
        }
        
        function loadProjectsFromLocalStorage() {
            const saved = localStorage.getItem('mandala_projects');
            if (saved) {
                try {
                    const loadedData = JSON.parse(saved);
                    projectData = { ...projectData, ...loadedData };
                } catch (error) {
                    console.error('è¼‰å…¥æœ¬æ©Ÿè³‡æ–™å¤±æ•—:', error);
                }
            }
        }
        
        // OPML åŒ¯å‡º/åŒ¯å…¥
        function exportCurrentOPML() {
            if (!currentProject) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å°ˆæ¡ˆ');
                return;
            }
            
            const opmlContent = projectDataToOPML(currentProject);
            const config = PROJECT_CONFIG[currentProject];
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 16);
            const fileName = `mandala_${currentProject}_${config.name}_${timestamp}.opml`;
            
            downloadFile(opmlContent, fileName);
        }
        
        function projectDataToOPML(projectId) {
            const config = PROJECT_CONFIG[projectId];
            const data = projectData[projectId];
            
            let opml = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
    <head>
        <title>æ›¼é™€ç¾…å°ˆæ¡ˆ: ${projectId} ${config.name}</title>
    </head>
    <body>
        <outline text="ä¸­å¿ƒ: ${escapeXml(data.center?.content || '')}">`;
            
            ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'].forEach(letter => {
                const section = data.sections?.[letter];
                opml += `
            <outline text="${letter}: ${escapeXml(section?.center?.content || '')}">`;
                
                ['1', '2', '3', '4', '5', '6', '7', '8'].forEach(num => {
                    const detail = section?.details?.[num];
                    opml += `
                <outline text="${num}: ${escapeXml(detail?.content || '')}"/>`;
                });
                
                opml += `
            </outline>`;
            });
            
            opml += `
        </outline>
    </body>
</opml>`;
            
            return opml;
        }
        
        function parseOPMLToProject(opmlContent, projectId) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(opmlContent, 'text/xml');
            
            const rootOutline = doc.querySelector('body > outline');
            if (!rootOutline) return;
            
            // è§£æä¸­å¿ƒå…§å®¹
            const rootText = rootOutline.getAttribute('text') || '';
            const centerContent = rootText.replace(/^ä¸­å¿ƒ:\s*/, '');
            
            if (!projectData[projectId]) {
                projectData[projectId] = createEmptyMandala();
            }
            
            projectData[projectId].center.content = centerContent;
            
            // è§£æå„å€åŸŸ
            const sectionNodes = rootOutline.querySelectorAll(':scope > outline');
            sectionNodes.forEach(sectionNode => {
                const sectionText = sectionNode.getAttribute('text') || '';
                const [letter, sectionContent] = sectionText.split(':');
                const sectionKey = letter.trim();
                
                if (/^[A-H]$/.test(sectionKey)) {
                    if (!projectData[projectId].sections[sectionKey]) {
                        projectData[projectId].sections[sectionKey] = { center: { content: '' }, details: {} };
                    }
                    
                    projectData[projectId].sections[sectionKey].center.content = (sectionContent || '').trim();
                    
                    // è§£æè©³ç´°å…§å®¹
                    const detailNodes = sectionNode.querySelectorAll(':scope > outline');
                    detailNodes.forEach(detailNode => {
                        const detailText = detailNode.getAttribute('text') || '';
                        const [num, detailContent] = detailText.split(':');
                        const numKey = num.trim();
                        
                        if (/^[1-8]$/.test(numKey)) {
                            if (!projectData[projectId].sections[sectionKey].details[numKey]) {
                                projectData[projectId].sections[sectionKey].details[numKey] = { content: '' };
                            }
                            projectData[projectId].sections[sectionKey].details[numKey].content = (detailContent || '').trim();
                        }
                    });
                }
            });
            
            saveToLocalStorage();
        }
        
        function importOPML() {
            document.getElementById('fileInput').click();
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (!currentProject) {
                        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å°ˆæ¡ˆé€²è¡ŒåŒ¯å…¥');
                        return;
                    }
                    
                    parseOPMLToProject(e.target.result, currentProject);
                    renderMandala();
                    alert('OPML åŒ¯å…¥æˆåŠŸï¼');
                } catch (error) {
                    alert('åŒ¯å…¥å¤±æ•—: æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
                }
            };
            reader.readAsText(file);
        }
        
        // æ¸…é™¤åŠŸèƒ½
        function clearCurrentLevel() {
            if (!currentProject) return;
            
            let message = '';
            if (currentLevel === 1) {
                message = 'ç¢ºå®šè¦æ¸…é™¤ç¬¬ä¸€å±¤çš„ A-H å€åŸŸå…§å®¹å—ï¼Ÿï¼ˆä¸åŒ…æ‹¬å„å€åŸŸçš„è©³ç´°å…§å®¹ï¼‰';
            } else {
                message = `ç¢ºå®šè¦æ¸…é™¤ ${currentSection} å€åŸŸçš„ 1-8 è©³ç´°å…§å®¹å—ï¼Ÿï¼ˆä¸åŒ…æ‹¬å€åŸŸä¸­å¿ƒï¼‰`;
            }
            
            if (!confirm(message)) return;
            
            if (currentLevel === 1) {
                // æ¸…é™¤ A-H å€åŸŸçš„ä¸­å¿ƒå…§å®¹
                ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'].forEach(letter => {
                    if (projectData[currentProject].sections[letter]) {
                        projectData[currentProject].sections[letter].center.content = '';
                    }
                });
            } else {
                // æ¸…é™¤ç•¶å‰å€åŸŸçš„ 1-8 è©³ç´°å…§å®¹
                if (projectData[currentProject].sections[currentSection]) {
                    ['1', '2', '3', '4', '5', '6', '7', '8'].forEach(num => {
                        if (projectData[currentProject].sections[currentSection].details[num]) {
                            projectData[currentProject].sections[currentSection].details[num].content = '';
                        }
                    });
                }
            }
            
            renderMandala();
            saveToLocalStorage();
            markProjectForSync(currentProject);
        }
        
        function clearEntireMandala() {
            if (!currentProject) return;
            
            const config = PROJECT_CONFIG[currentProject];
            const message = `âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ•´å€‹ã€Œ${currentProject} ${config.name}ã€æ›¼é™€ç¾…çš„æ‰€æœ‰å…§å®¹å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡æ¸…é™¤ï¼š\n- ä¸­å¿ƒä¸»é¡Œ\n- æ‰€æœ‰ A-H å€åŸŸå…§å®¹\n- æ‰€æœ‰è©³ç´°å…§å®¹ (1-8)\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
            
            if (!confirm(message)) return;
            
            // é‡ç½®æ•´å€‹å°ˆæ¡ˆ
            projectData[currentProject] = createEmptyMandala();
            
            renderMandala();
            saveToLocalStorage();
            markProjectForSync(currentProject);
            
            alert('æ›¼é™€ç¾…å·²æ¸…é™¤å®Œæˆ');
        }
        
        // å·¥å…·å‡½æ•¸
        function escapeXml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(match) {
                const escapeMap = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&apos;'
                };
                return escapeMap[match];
            });
        }
        
        function downloadFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // å›ºå®šç¶²å€éƒ¨ç½²ç›¸é—œ
        function showDeployModal() {
            document.getElementById('deployModal').classList.remove('hidden');
        }
        
        function closeDeployModal() {
            document.getElementById('deployModal').classList.add('hidden');
        }
        
        function downloadHTML() {
            // ç²å–ç•¶å‰é é¢çš„HTMLå…§å®¹
            const htmlContent = document.documentElement.outerHTML;
            downloadFile(htmlContent, 'mandala_system.html');
            alert('HTMLæª”æ¡ˆå·²ä¸‹è¼‰ï¼Œæ‚¨å¯ä»¥éƒ¨ç½²åˆ°ä»»ä½•ä¼ºæœå™¨ç²å¾—å›ºå®šç¶²å€ï¼');
        }
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9789df3c5ef47d1b","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.8.0","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDpSqVKo6qAeAi7LETwLVXyDZMHIMjbI1ka%2FPLM0saSZwTcot2Wy1haxSSPhHmIn5WZWBTwmuXGsVNR7ZvPVLkjY%2FY4ZvZnw6IZjGi4zVwtp89B05hXGOVuDYOIMwDk37JSMlSXj4Xah0UOkEHV1hZsk32Go5DUpNucxpNR0fVhWa6gxD49jyFfUNvAGie87agei6l7px68ExTf1JG1h5N%2FkBhdHEPrc%2FtkcpNayn0M4BJ86yLVp0c7CyE2PUf%2FM0WCLkRdg9bw5QbQR6W37BVKGuhgUksid0CsSNJmbwAfrFnhPEfNXGM7q2Rs8k04f4pGaps40gApJBcKnoEb%2FBEIY4OnSzsqOSeKZWi8O3drpOXQVcauIHRf3RxzSkUpLCnb3ikqyYKTTmqllNCUzMcJ3T8nJ%2FXGKa2N7qZDS7yNGrR%2B4IJyXMDrVwy5e%2BrpU80X5%2B7PHqjX%2Bl8lJEmyVZa%2FIky3ofKRadhqRHxRsphPg9iYJwQMQ74lz4fsN98dXl%2B1G967mGeLXXmfRshSloNOM%3D";
        window.__genspark_locale = "zh-TW";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDpSqVKo6qAeAi7LETwLVXyDZMHIMjbI1ka/PLM0saSZwTcot2Wy1haxSSPhHmIn5WZWBTwmuXGsVNR7ZvPVLkjY/Y4ZvZnw6IZjGi4zVwtp89B05hXGOVuDYOIMwDk37JSMlSXj4Xah0UOkEHV1hZsk32Go5DUpNucxpNR0fVhWa6gxD49jyFfUNvAGie87agei6l7px68ExTf1JG1h5N/kBhdHEPrc/tkcpNayn0M4BJ86yLVp0c7CyE2PUf/M0WCLkRdg9bw5QbQR6W37BVKGuhgUksid0CsSNJmbwAfrFnhPEfNXGM7q2Rs8k04f4pGaps40gApJBcKnoEb/BEIY4OnSzsqOSeKZWi8O3drpOXQVcauIHRf3RxzSkUpLCnb3ikqyYKTTmqllNCUzMcJ3T8nJ/XGKa2N7qZDS7yNGrR+4IJyXMDrVwy5e+rpU80X5+7PHqjX+l8lJEmyVZa/Iky3ofKRadhqRHxRsphPg9iYJwQMQ74lz4fsN98dXl+1G967mGeLXXmfRshSloNOM=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    